# CI Checks Integration — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Mostrar estado CI (✅/❌/⏳) en branches/PRs del panel de issues, y añadir un botón en configuración del proyecto para generar `.github/workflows/ci.yml` en el repo conectado.

**Architecture:** Dos nuevas funciones PHP en `app/api/github.php` que usan la GitHub Checks API y la GitHub Contents API respectivamente. La UI se actualiza en `app/assets/js/issues.js` (chips de estado en branches) y `app/pages/project.php` (botón generar workflow).

**Tech Stack:** PHP 8.x, GitHub REST API v3 (Checks API, Contents API), Vanilla JS, Laragon local.

---

### Contexto del codebase

- Repo: `C:\Users\carlo\proyects\claude-skills`
- URL local: `http://localhost/teamapp/public`
- Token GitHub guardado encriptado en `github_repos.access_token`
- `github_request($token, $endpoint, $method, $body)` ya existe — wrapper para GitHub API
- `get_repo_for_project($project_id)` ya existe — devuelve repo con token decriptado
- No hay test suite — verificar abriendo la URL en el navegador

---

### Task 1: Añadir `get_check_status()` a github.php

**Files:**
- Modify: `app/api/github.php` (añadir función y ruta HTTP)

**Step 1: Añadir la función `get_check_status()` antes del bloque `if (php_sapi_name() !== 'cli')`**

Insertar justo antes de la línea `// HTTP routing` (línea ~433):

```php
function get_check_status(int $project_id, string $ref, int $user_id): array {
    $repo = get_repo_for_project($project_id);
    if (!$repo) return ['success' => true, 'overall' => 'none', 'count' => 0];
    $token = $repo['access_token'] ?: get_user_github_token($user_id);
    if (!$token) return ['success' => true, 'overall' => 'none', 'count' => 0];

    $result = github_request($token,
        "repos/{$repo['repo_full_name']}/commits/" . urlencode($ref) . "/check-runs?per_page=50"
    );

    // Graceful degradation: if no permission or branch not found, return 'none' silently
    if ($result['status'] !== 200) {
        return ['success' => true, 'overall' => 'none', 'count' => 0];
    }

    $runs = $result['body']['check_runs'] ?? [];
    if (empty($runs)) {
        return ['success' => true, 'overall' => 'none', 'count' => 0];
    }

    $overall = 'success';
    $failUrl = '';
    foreach ($runs as $run) {
        if ($run['status'] !== 'completed') {
            $overall = 'running';
            break;
        }
        if (in_array($run['conclusion'], ['failure', 'timed_out', 'action_required'])) {
            $overall  = 'failure';
            $failUrl  = $run['html_url'] ?? '';
            break;
        }
    }

    return [
        'success'  => true,
        'overall'  => $overall,
        'fail_url' => $failUrl,
        'count'    => count($runs),
    ];
}
```

**Step 2: Añadir la ruta HTTP en el bloque `match(true)`**

En el bloque match, añadir antes de `default => null`:

```php
$method === 'GET'  && $action === 'check_status'    => print json_encode(get_check_status((int)($_GET['project_id']??0), $_GET['ref']??'', current_user()['id'])),
$method === 'POST' && $action === 'generate_workflow'=> print json_encode(isset($b['project_id']) ? generate_workflow((int)$b['project_id'], current_user()['id']) : ['success'=>false,'error'=>'Missing project_id']),
```

(La función `generate_workflow` se añade en Task 2 — ambas rutas van juntas en el match.)

**Step 3: Verificar sintaxis**

```bash
php -l app/api/github.php
```
Esperado: `No syntax errors detected in app/api/github.php`

**Step 4: Probar en el navegador**

Abrir: `http://localhost/teamapp/public/app/api/github.php?action=check_status&project_id=1&ref=main`

Esperado: JSON con `{"success":true,"overall":"none","count":0}` (o datos reales si hay checks en la rama main)

**Step 5: Commit**

```bash
git add app/api/github.php
git commit -m "feat: add get_check_status() — GitHub Checks API integration"
```

---

### Task 2: Añadir `generate_workflow()` a github.php

**Files:**
- Modify: `app/api/github.php`

**Step 1: Añadir la función `generate_workflow()` antes del bloque `// HTTP routing`**

Insertar justo después de `get_check_status()`:

```php
function generate_workflow(int $project_id, int $user_id): array {
    $repo = get_repo_for_project($project_id);
    if (!$repo) return ['success' => false, 'error' => 'No repo connected'];
    $token = $repo['access_token'] ?: get_user_github_token($user_id);
    if (!$token) return ['success' => false, 'error' => 'No GitHub token available'];

    $path = '.github/workflows/ci.yml';

    $yaml = <<<'YAML'
name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: PHP Syntax check
        run: find . -name "*.php" -not -path "*/vendor/*" | xargs php -l
      - name: Setup Node.js
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install JS deps
        if: hashFiles('package.json') != ''
        run: npm ci
      - name: JS lint
        if: hashFiles('package.json') != '' && hashFiles('.eslintrc*') != ''
        run: npm run lint
YAML;

    $content = base64_encode($yaml);

    // Check if file already exists (need its SHA for update)
    $existing = github_request($token, "repos/{$repo['repo_full_name']}/contents/" . urlencode($path));
    $body = [
        'message' => 'ci: add GitHub Actions CI workflow',
        'content' => $content,
    ];
    if ($existing['status'] === 200) {
        $body['sha'] = $existing['body']['sha'];
        $body['message'] = 'ci: update GitHub Actions CI workflow';
    }

    $result = github_request($token,
        "repos/{$repo['repo_full_name']}/contents/" . urlencode($path),
        'PUT',
        $body
    );

    if (!in_array($result['status'], [200, 201])) {
        $msg = $result['body']['message'] ?? 'Error creating workflow file';
        if (str_contains($msg, 'Resource not accessible')) {
            $msg = 'Token lacks write permissions. For Classic PATs enable the "repo" scope.';
        }
        return ['success' => false, 'error' => $msg];
    }

    return [
        'success' => true,
        'updated' => $existing['status'] === 200,
        'path'    => $path,
    ];
}
```

**Step 2: Verificar sintaxis**

```bash
php -l app/api/github.php
```
Esperado: `No syntax errors detected in app/api/github.php`

**Step 3: Verificar en navegador (prueba manual)**

Ir a `http://localhost/teamapp/public?page=project`, tener un repo conectado con token `repo` scope, y usar DevTools > Console:

```js
fetch('/teamapp/public/app/api/github.php?action=repo_status&project_id=1').then(r=>r.json()).then(console.log)
```
Confirmar que el repo está conectado antes del Task 3.

**Step 4: Commit**

```bash
git add app/api/github.php
git commit -m "feat: add generate_workflow() — push ci.yml to connected GitHub repo"
```

---

### Task 3: Botón "Generar workflow CI" en project.php

**Files:**
- Modify: `app/pages/project.php` (función `loadRepoStatus()`, línea ~377)

**Contexto:** La función `loadRepoStatus()` en el `<script>` de project.php construye el innerHTML del elemento `#github-repo-card` cuando hay repo conectado (línea ~378). Actualmente renderiza nombre del repo y link. Hay que añadir el botón de CI debajo.

**Step 1: Modificar el innerHTML del card cuando `data.connected` es true**

Localizar este bloque (línea ~378-389):
```js
        card.innerHTML = `
            <div class="flex items-center gap-4">
                <span style="font-size:2rem;">&#128279;</span>
                <div class="flex-1">
                    <div class="font-semibold">${data.repo}</div>
                    <div class="text-sm text-muted mt-1">Conectado al proyecto activo</div>
                </div>
                <a href="https://github.com/${data.repo}" target="_blank"
                    class="text-sm" style="color:var(--color-primary);text-decoration:none;">
                    Ver en GitHub ↗
                </a>
            </div>`;
```

Reemplazarlo con (añadir el bloque de CI al final del template):
```js
        card.innerHTML = `
            <div class="flex items-center gap-4">
                <span style="font-size:2rem;">&#128279;</span>
                <div class="flex-1">
                    <div class="font-semibold">${data.repo}</div>
                    <div class="text-sm text-muted mt-1">Conectado al proyecto activo</div>
                </div>
                <a href="https://github.com/${data.repo}" target="_blank"
                    class="text-sm" style="color:var(--color-primary);text-decoration:none;">
                    Ver en GitHub ↗
                </a>
            </div>
            <div class="mt-3 pt-3" style="border-top:1px solid var(--border);">
                <button id="gen-workflow-btn" class="btn btn-secondary btn-sm">&#9889; Generar workflow CI</button>
                <span id="gen-workflow-msg" class="text-sm text-muted ml-2"></span>
            </div>`;
        // Attach CI button handler after innerHTML is set
        document.getElementById('gen-workflow-btn').addEventListener('click', generateCiWorkflow);
```

**Step 2: Añadir la función `generateCiWorkflow` en el mismo bloque `<script>`**

Añadir después de la función `loadRepoBranches` (buscar el cierre `}` de esa función, añadir después):

```js
async function generateCiWorkflow() {
    const btn = document.getElementById('gen-workflow-btn');
    const msg = document.getElementById('gen-workflow-msg');
    btn.disabled = true;
    btn.textContent = 'Generando...';
    msg.textContent = '';
    try {
        const res  = await apiFetch(`${APP_URL}/app/api/github.php?action=generate_workflow`, {
            method: 'POST',
            body: JSON.stringify({ project_id: PROJECT_ID })
        });
        const data = await res.json();
        if (data.success) {
            showToast(data.updated ? 'Workflow CI actualizado en el repo' : 'Workflow CI creado en el repo ✅');
            msg.textContent = '.github/workflows/ci.yml ' + (data.updated ? 'actualizado' : 'creado');
        } else {
            showToast(data.error || 'Error al generar workflow', 'error');
        }
    } catch(e) {
        showToast('Error de red', 'error');
    }
    btn.disabled = false;
    btn.innerHTML = '&#9889; Generar workflow CI';
}
```

**Step 3: Verificar sintaxis**

```bash
php -l app/pages/project.php
```
Esperado: `No syntax errors detected`

**Step 4: Probar en navegador**

1. Ir a `http://localhost/teamapp/public?page=project`
2. Seleccionar proyecto con repo conectado
3. Debe aparecer el botón `⚡ Generar workflow CI` debajo del nombre del repo
4. Hacer clic → debe mostrar toast de éxito y mensaje `.github/workflows/ci.yml creado`
5. Verificar en GitHub que el archivo existe en el repo

**Step 5: Commit**

```bash
git add app/pages/project.php
git commit -m "feat: add 'Generar workflow CI' button in project GitHub settings"
```

---

### Task 4: CI chips en `loadBranches()` — panel lateral de issue

**Files:**
- Modify: `app/assets/js/issues.js` (función `loadBranches`, línea ~228)

**Contexto:** `loadBranches(id)` obtiene las branches de una issue y las renderiza en `#branch-list`. Hay que:
1. Tras obtener las branches, hacer fetch paralelo de check_status para cada una
2. Añadir el chip de estado en el HTML de cada branch

**Step 1: Añadir función helper `ciChip` cerca del inicio del archivo (línea ~15, después de las constantes)**

```js
function ciChip(overall, failUrl) {
    if (overall === 'success') {
        return `<span style="font-size:0.7rem;background:#dcfce7;color:#166534;border-radius:999px;padding:0.1rem 0.5rem;font-weight:600;white-space:nowrap;">&#10003; CI passed</span>`;
    }
    if (overall === 'failure') {
        const link = failUrl ? ` <a href="${escapeHtml(failUrl)}" target="_blank" style="color:#991b1b;">&#8599;</a>` : '';
        return `<span style="font-size:0.7rem;background:#fee2e2;color:#991b1b;border-radius:999px;padding:0.1rem 0.5rem;font-weight:600;white-space:nowrap;">&#10007; CI failed${link}</span>`;
    }
    if (overall === 'running') {
        return `<span style="font-size:0.7rem;background:#fef9c3;color:#854d0e;border-radius:999px;padding:0.1rem 0.5rem;font-weight:600;white-space:nowrap;">&#9203; Running</span>`;
    }
    return '';
}
```

**Step 2: Modificar `loadBranches(id)` para obtener check status en paralelo**

Localizar el bloque completo desde `const branches = data.data || [];` hasta el cierre `}` de la función (líneas ~247-265). Reemplazar:

```js
    const branches = data.data || [];
    if (!branches.length) { list.innerHTML = '<em style="color:var(--text-tertiary)">Sin ramas aún</em>'; return; }
    list.innerHTML = branches.map(b => {
        const existingPR = currentPRs.find(pr => pr.branch === b.branch_name);
        const prBtn = existingPR
            ? `<button onclick="openDiffViewer(${existingPR.number})" style="font-size:0.75rem;color:#fff;background:var(--color-primary);border:none;border-radius:4px;padding:0.25rem 0.6rem;cursor:pointer;font-weight:600;">PR #${existingPR.number} &#128065;</button>`
            : `<button onclick="openCreatePRModal('${escapeHtml(b.branch_name)}')" style="font-size:0.75rem;color:#16a34a;background:none;border:1px solid #16a34a;border-radius:4px;padding:0.25rem 0.6rem;cursor:pointer;">&#8593; Create PR</button>`;
        return `<div class="branch-item" style="margin-bottom:0.5rem;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:0.4rem;">
                <span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">&#127807; ${escapeHtml(b.branch_name)} <span style="color:var(--text-tertiary);font-size:0.8rem">by ${escapeHtml(b.creator_name)}</span></span>
                <div style="display:flex;gap:0.3rem;flex-shrink:0;">
                    ${prBtn}
                    <button onclick="toggleCommits(${id}, '${escapeHtml(b.branch_name)}', this)" style="font-size:0.75rem;color:var(--color-primary);background:none;border:none;cursor:pointer;">&#9654; Commits</button>
                </div>
            </div>
            <div class="commits-panel" style="display:none;margin-top:0.4rem;padding-left:0.75rem;border-left:2px solid #e5e7eb;"></div>
        </div>`;
    }).join('');
```

Con esto:

```js
    const branches = data.data || [];
    if (!branches.length) { list.innerHTML = '<em style="color:var(--text-tertiary)">Sin ramas aún</em>'; return; }

    // Fetch CI status for all branches in parallel (graceful — never blocks branch display)
    const ciResults = await Promise.all(
        branches.map(b =>
            fetch(`${APP_URL}/app/api/github.php?action=check_status&project_id=${PROJECT_ID}&ref=${encodeURIComponent(b.branch_name)}`)
                .then(r => r.json())
                .catch(() => ({ overall: 'none' }))
        )
    );

    list.innerHTML = branches.map((b, i) => {
        const ci = ciResults[i] || {};
        const existingPR = currentPRs.find(pr => pr.branch === b.branch_name);
        const prBtn = existingPR
            ? `<button onclick="openDiffViewer(${existingPR.number})" style="font-size:0.75rem;color:#fff;background:var(--color-primary);border:none;border-radius:4px;padding:0.25rem 0.6rem;cursor:pointer;font-weight:600;">PR #${existingPR.number} &#128065;</button>`
            : `<button onclick="openCreatePRModal('${escapeHtml(b.branch_name)}')" style="font-size:0.75rem;color:#16a34a;background:none;border:1px solid #16a34a;border-radius:4px;padding:0.25rem 0.6rem;cursor:pointer;">&#8593; Create PR</button>`;
        return `<div class="branch-item" style="margin-bottom:0.5rem;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:0.4rem;flex-wrap:wrap;">
                <span style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">&#127807; ${escapeHtml(b.branch_name)} <span style="color:var(--text-tertiary);font-size:0.8rem">by ${escapeHtml(b.creator_name)}</span></span>
                <div style="display:flex;gap:0.3rem;flex-shrink:0;align-items:center;flex-wrap:wrap;">
                    ${ciChip(ci.overall, ci.fail_url)}
                    ${prBtn}
                    <button onclick="toggleCommits(${id}, '${escapeHtml(b.branch_name)}', this)" style="font-size:0.75rem;color:var(--color-primary);background:none;border:none;cursor:pointer;">&#9654; Commits</button>
                </div>
            </div>
            <div class="commits-panel" style="display:none;margin-top:0.4rem;padding-left:0.75rem;border-left:2px solid #e5e7eb;"></div>
        </div>`;
    }).join('');
```

**Step 3: Probar en navegador**

1. Ir a `http://localhost/teamapp/public?page=issues`
2. Abrir una issue que tenga branches con GitHub Actions configurado
3. En el panel lateral, sección "Ramas GitHub", debe aparecer el chip de CI junto a cada branch

**Step 4: Commit**

```bash
git add app/assets/js/issues.js
git commit -m "feat: show CI check status chips in issue side panel branches"
```

---

### Task 5: CI chips en `loadFullIssueBranches()` — modal full issue

**Files:**
- Modify: `app/assets/js/issues.js` (función `loadFullIssueBranches`, línea ~1040)

**Contexto:** `loadFullIssueBranches(id)` renderiza las branches en el modal de issue expandida (`#fi-branches`). Mismo patrón que Task 4.

**Step 1: Modificar `loadFullIssueBranches()` para incluir CI chips**

Localizar (líneas ~1040-1048):
```js
async function loadFullIssueBranches(id) {
    const res = await fetch(`${APP_URL}/app/api/github.php?action=branches&issue_id=${id}`);
    const data = await res.json();
    const branches = data.data || [];
    const el = document.getElementById('fi-branches');
    if (!branches.length) { el.innerHTML = '<em style="color:var(--text-tertiary);font-size:0.8rem;">Sin ramas</em>'; return; }
    el.innerHTML = branches.map(b =>
        `<div style="padding:0.25rem 0;border-bottom:1px solid var(--border);font-size:0.78rem;font-family:monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">&#127807; ${escapeHtml(b.branch_name)}</div>`
    ).join('');
}
```

Reemplazar con:
```js
async function loadFullIssueBranches(id) {
    const res = await fetch(`${APP_URL}/app/api/github.php?action=branches&issue_id=${id}`);
    const data = await res.json();
    const branches = data.data || [];
    const el = document.getElementById('fi-branches');
    if (!branches.length) { el.innerHTML = '<em style="color:var(--text-tertiary);font-size:0.8rem;">Sin ramas</em>'; return; }

    const ciResults = await Promise.all(
        branches.map(b =>
            fetch(`${APP_URL}/app/api/github.php?action=check_status&project_id=${PROJECT_ID}&ref=${encodeURIComponent(b.branch_name)}`)
                .then(r => r.json())
                .catch(() => ({ overall: 'none' }))
        )
    );

    el.innerHTML = branches.map((b, i) => {
        const ci = ciResults[i] || {};
        return `<div style="display:flex;align-items:center;gap:0.4rem;padding:0.3rem 0;border-bottom:1px solid var(--border);flex-wrap:wrap;">
            <span style="font-size:0.78rem;font-family:monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0;">&#127807; ${escapeHtml(b.branch_name)}</span>
            ${ciChip(ci.overall, ci.fail_url)}
        </div>`;
    }).join('');
}
```

**Step 2: Probar en navegador**

1. Abrir una issue en modo expandido (clic en el título de la issue)
2. En la sección "Ramas", debe aparecer el chip de CI junto a cada branch

**Step 3: Commit**

```bash
git add app/assets/js/issues.js
git commit -m "feat: show CI check status chips in full issue modal branches"
```

---

### Verificación final

1. `php -l app/api/github.php` → sin errores
2. `php -l app/pages/project.php` → sin errores
3. En `http://localhost/teamapp/public?page=project`:
   - Repo conectado → aparece botón "⚡ Generar workflow CI"
   - Clic en el botón → toast de éxito, mensaje de confirmación
   - Verificar en GitHub que `.github/workflows/ci.yml` fue creado
4. En `http://localhost/teamapp/public?page=issues`:
   - Issues con branches → chips de CI en panel lateral y en modal expandido
   - Sin checks configurados → no aparece ningún chip (graceful)
   - Con checks → aparece el chip correcto (✅/❌/⏳)
