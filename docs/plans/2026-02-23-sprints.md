# Sprints Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add sprints (time-boxed iterations) to the app: DB schema, full REST API, Sprint Kanban page with backlog, and sprint management modal.

**Architecture:** New `sprints` table + `sprint_id` column on `issues`. New API file `app/api/sprints.php` with 9 actions. New page `sprint.php` + `sprint.js` using the existing Kanban HTML/CSS patterns. Sidebar gets a Sprint link.

**Tech Stack:** PHP 8.x vanilla · MySQL 8.x · Vanilla JS · Existing kanban CSS classes

---

### Task 1: DB migration + schema

**Files:**
- Create: `db/migrations/add_sprints.sql`
- Modify: `db/schema.sql`

**Step 1: Create migration file**

Create `db/migrations/add_sprints.sql` with this content:

```sql
CREATE TABLE IF NOT EXISTS sprints (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    status ENUM('planning','active','completed') NOT NULL DEFAULT 'planning',
    created_by INT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE RESTRICT
) ENGINE=InnoDB CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

ALTER TABLE issues
    ADD COLUMN sprint_id INT DEFAULT NULL,
    ADD CONSTRAINT fk_issue_sprint FOREIGN KEY (sprint_id) REFERENCES sprints(id) ON DELETE SET NULL;
```

**Step 2: Run migration**

```bash
/c/laragon/bin/mysql/mysql-8.0.30-winx64/bin/mysql.exe -u root teamapp < db/migrations/add_sprints.sql
```

Expected: no errors. If you see "Duplicate column name", the column already exists — skip.

**Step 3: Update db/schema.sql**

In `db/schema.sql`, find the `issues` table. Add after the `due_date` line (already has `story_points`):

The `issues` table already has `story_points` added. Add `sprint_id` after `story_points`:

```sql
    story_points TINYINT UNSIGNED NULL DEFAULT NULL,
    sprint_id INT DEFAULT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
```

And add to the FK block inside the `issues` CREATE TABLE:
```sql
    FOREIGN KEY (sprint_id) REFERENCES sprints(id) ON DELETE SET NULL
```

Then append the full `sprints` table definition at the end of `db/schema.sql` (before the final blank line):

```sql
CREATE TABLE IF NOT EXISTS sprints (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    status ENUM('planning','active','completed') NOT NULL DEFAULT 'planning',
    created_by INT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE RESTRICT
) ENGINE=InnoDB CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

**Step 4: Commit**

```bash
git add db/migrations/add_sprints.sql db/schema.sql
git commit -m "feat: add sprints table and sprint_id to issues (migration + schema)"
```

---

### Task 2: API — app/api/sprints.php

**Files:**
- Create: `app/api/sprints.php`

**Step 1: Create the full API file**

Create `app/api/sprints.php`:

```php
<?php
require_once __DIR__ . '/../bootstrap.php';

if (php_sapi_name() !== 'cli') {
    require_auth();
    header('Content-Type: application/json');
    $method = $_SERVER['REQUEST_METHOD'];
    $action = $_GET['action'] ?? '';
    $user   = current_user();
    $uid    = $user['id'];

    if ($method === 'POST') { verify_csrf(); }
    $b = $method === 'POST' ? (json_decode(file_get_contents('php://input'), true) ?? []) : [];

    match(true) {

        // List all sprints for a project
        $method === 'GET' && $action === 'list' => (function() {
            $project_id = (int)($_GET['project_id'] ?? 0);
            if (!$project_id) { print json_encode(['success' => false, 'error' => 'project_id requerido']); return; }
            require_project_access($project_id);
            $stmt = get_db()->prepare(
                "SELECT s.*, u.name AS creator_name,
                    (SELECT COUNT(*) FROM issues WHERE sprint_id = s.id) AS issue_count
                 FROM sprints s JOIN users u ON s.created_by = u.id
                 WHERE s.project_id = ?
                 ORDER BY FIELD(s.status,'active','planning','completed'), s.start_date DESC"
            );
            $stmt->execute([$project_id]);
            print json_encode(['success' => true, 'data' => $stmt->fetchAll(PDO::FETCH_ASSOC)]);
        })(),

        // Get sprint with its issues
        $method === 'GET' && $action === 'get' => (function() {
            $id = (int)($_GET['id'] ?? 0);
            if (!$id) { print json_encode(['success' => false, 'error' => 'id requerido']); return; }
            $pdo = get_db();
            $stmt = $pdo->prepare("SELECT * FROM sprints WHERE id = ?");
            $stmt->execute([$id]);
            $sprint = $stmt->fetch(PDO::FETCH_ASSOC);
            if (!$sprint) { print json_encode(['success' => false, 'error' => 'Sprint no encontrado']); return; }
            require_project_access((int)$sprint['project_id']);
            $issStmt = $pdo->prepare(
                "SELECT i.*, u.name AS assignee_name, t.name AS type_name, t.color AS type_color
                 FROM issues i
                 LEFT JOIN users u ON i.assigned_to = u.id
                 LEFT JOIN issue_types t ON i.type_id = t.id
                 WHERE i.sprint_id = ?
                 ORDER BY FIELD(i.priority,'critical','high','medium','low'), i.created_at DESC"
            );
            $issStmt->execute([$id]);
            $sprint['issues'] = $issStmt->fetchAll(PDO::FETCH_ASSOC);
            print json_encode(['success' => true, 'data' => $sprint]);
        })(),

        // Issues without a sprint (backlog)
        $method === 'GET' && $action === 'backlog' => (function() {
            $project_id = (int)($_GET['project_id'] ?? 0);
            if (!$project_id) { print json_encode(['success' => false, 'error' => 'project_id requerido']); return; }
            require_project_access($project_id);
            $stmt = get_db()->prepare(
                "SELECT i.*, u.name AS assignee_name, t.name AS type_name, t.color AS type_color
                 FROM issues i
                 LEFT JOIN users u ON i.assigned_to = u.id
                 LEFT JOIN issue_types t ON i.type_id = t.id
                 WHERE i.project_id = ? AND i.sprint_id IS NULL AND i.status != 'done'
                 ORDER BY FIELD(i.priority,'critical','high','medium','low'), i.created_at DESC"
            );
            $stmt->execute([$project_id]);
            print json_encode(['success' => true, 'data' => $stmt->fetchAll(PDO::FETCH_ASSOC)]);
        })(),

        // Create sprint
        $method === 'POST' && $action === 'create' => (function() use ($b, $uid) {
            $project_id = (int)($b['project_id'] ?? 0);
            $name       = trim($b['name']       ?? '');
            $start_date = trim($b['start_date'] ?? '');
            $end_date   = trim($b['end_date']   ?? '');
            if (!$project_id || !$name || !$start_date || !$end_date) {
                print json_encode(['success' => false, 'error' => 'Faltan campos requeridos']); return;
            }
            if ($start_date >= $end_date) {
                print json_encode(['success' => false, 'error' => 'La fecha de fin debe ser posterior a la de inicio']); return;
            }
            require_project_access($project_id);
            $pdo = get_db();
            $pdo->prepare("INSERT INTO sprints (project_id, name, start_date, end_date, created_by) VALUES (?,?,?,?,?)")
                ->execute([$project_id, $name, $start_date, $end_date, $uid]);
            print json_encode(['success' => true, 'id' => (int)$pdo->lastInsertId()]);
        })(),

        // Update sprint (only if planning)
        $method === 'POST' && $action === 'update' => (function() use ($b) {
            $id         = (int)($b['id']         ?? 0);
            $name       = trim($b['name']        ?? '');
            $start_date = trim($b['start_date']  ?? '');
            $end_date   = trim($b['end_date']    ?? '');
            if (!$id || !$name || !$start_date || !$end_date) {
                print json_encode(['success' => false, 'error' => 'Faltan campos requeridos']); return;
            }
            if ($start_date >= $end_date) {
                print json_encode(['success' => false, 'error' => 'La fecha de fin debe ser posterior a la de inicio']); return;
            }
            $pdo  = get_db();
            $stmt = $pdo->prepare("SELECT project_id, status FROM sprints WHERE id = ?");
            $stmt->execute([$id]);
            $sprint = $stmt->fetch(PDO::FETCH_ASSOC);
            if (!$sprint) { print json_encode(['success' => false, 'error' => 'Sprint no encontrado']); return; }
            if ($sprint['status'] !== 'planning') {
                print json_encode(['success' => false, 'error' => 'Solo se pueden editar sprints en planning']); return;
            }
            require_project_access((int)$sprint['project_id']);
            $pdo->prepare("UPDATE sprints SET name=?, start_date=?, end_date=? WHERE id=?")
                ->execute([$name, $start_date, $end_date, $id]);
            print json_encode(['success' => true]);
        })(),

        // Start sprint: planning → active (only one active per project)
        $method === 'POST' && $action === 'start' => (function() use ($b) {
            $id = (int)($b['id'] ?? 0);
            if (!$id) { print json_encode(['success' => false, 'error' => 'id requerido']); return; }
            $pdo  = get_db();
            $stmt = $pdo->prepare("SELECT project_id, status FROM sprints WHERE id = ?");
            $stmt->execute([$id]);
            $sprint = $stmt->fetch(PDO::FETCH_ASSOC);
            if (!$sprint) { print json_encode(['success' => false, 'error' => 'Sprint no encontrado']); return; }
            if ($sprint['status'] !== 'planning') {
                print json_encode(['success' => false, 'error' => 'Solo se pueden iniciar sprints en planning']); return;
            }
            require_project_access((int)$sprint['project_id']);
            $check = $pdo->prepare("SELECT id FROM sprints WHERE project_id = ? AND status = 'active'");
            $check->execute([$sprint['project_id']]);
            if ($check->fetch()) {
                print json_encode(['success' => false, 'error' => 'Ya hay un sprint activo en este proyecto']); return;
            }
            $pdo->prepare("UPDATE sprints SET status = 'active' WHERE id = ?")->execute([$id]);
            print json_encode(['success' => true]);
        })(),

        // Complete sprint: active → completed, non-done issues go to backlog
        $method === 'POST' && $action === 'complete' => (function() use ($b) {
            $id = (int)($b['id'] ?? 0);
            if (!$id) { print json_encode(['success' => false, 'error' => 'id requerido']); return; }
            $pdo  = get_db();
            $stmt = $pdo->prepare("SELECT project_id, status FROM sprints WHERE id = ?");
            $stmt->execute([$id]);
            $sprint = $stmt->fetch(PDO::FETCH_ASSOC);
            if (!$sprint) { print json_encode(['success' => false, 'error' => 'Sprint no encontrado']); return; }
            if ($sprint['status'] !== 'active') {
                print json_encode(['success' => false, 'error' => 'Solo se pueden completar sprints activos']); return;
            }
            require_project_access((int)$sprint['project_id']);
            $pdo->prepare("UPDATE issues SET sprint_id = NULL WHERE sprint_id = ? AND status != 'done'")
                ->execute([$id]);
            $pdo->prepare("UPDATE sprints SET status = 'completed' WHERE id = ?")->execute([$id]);
            print json_encode(['success' => true]);
        })(),

        // Delete sprint (manager+, only if no issues assigned)
        $method === 'POST' && $action === 'delete' => (function() use ($b) {
            $id = (int)($b['id'] ?? 0);
            if (!$id) { print json_encode(['success' => false, 'error' => 'id requerido']); return; }
            $pdo  = get_db();
            $stmt = $pdo->prepare("SELECT project_id FROM sprints WHERE id = ?");
            $stmt->execute([$id]);
            $sprint = $stmt->fetch(PDO::FETCH_ASSOC);
            if (!$sprint) { print json_encode(['success' => false, 'error' => 'Sprint no encontrado']); return; }
            require_project_access((int)$sprint['project_id']);
            require_role('manager');
            $cnt = $pdo->prepare("SELECT COUNT(*) FROM issues WHERE sprint_id = ?");
            $cnt->execute([$id]);
            if ((int)$cnt->fetchColumn() > 0) {
                print json_encode(['success' => false, 'error' => 'No se puede eliminar un sprint con issues asignadas']); return;
            }
            $pdo->prepare("DELETE FROM sprints WHERE id = ?")->execute([$id]);
            print json_encode(['success' => true]);
        })(),

        // Add issue to sprint
        $method === 'POST' && $action === 'add_issue' => (function() use ($b) {
            $sprint_id = (int)($b['sprint_id'] ?? 0);
            $issue_id  = (int)($b['issue_id']  ?? 0);
            if (!$sprint_id || !$issue_id) {
                print json_encode(['success' => false, 'error' => 'sprint_id e issue_id requeridos']); return;
            }
            $pdo  = get_db();
            $stmt = $pdo->prepare("SELECT project_id FROM sprints WHERE id = ? AND status != 'completed'");
            $stmt->execute([$sprint_id]);
            $sprint = $stmt->fetch(PDO::FETCH_ASSOC);
            if (!$sprint) { print json_encode(['success' => false, 'error' => 'Sprint no encontrado o ya completado']); return; }
            require_project_access((int)$sprint['project_id']);
            $iStmt = $pdo->prepare("SELECT id FROM issues WHERE id = ? AND project_id = ?");
            $iStmt->execute([$issue_id, $sprint['project_id']]);
            if (!$iStmt->fetch()) { print json_encode(['success' => false, 'error' => 'Issue no encontrada en este proyecto']); return; }
            $pdo->prepare("UPDATE issues SET sprint_id = ? WHERE id = ?")->execute([$sprint_id, $issue_id]);
            print json_encode(['success' => true]);
        })(),

        // Remove issue from sprint (back to backlog)
        $method === 'POST' && $action === 'remove_issue' => (function() use ($b) {
            $issue_id = (int)($b['issue_id'] ?? 0);
            if (!$issue_id) { print json_encode(['success' => false, 'error' => 'issue_id requerido']); return; }
            $pdo  = get_db();
            $stmt = $pdo->prepare("SELECT project_id FROM issues WHERE id = ?");
            $stmt->execute([$issue_id]);
            $issue = $stmt->fetch(PDO::FETCH_ASSOC);
            if (!$issue) { print json_encode(['success' => false, 'error' => 'Issue no encontrada']); return; }
            require_project_access((int)$issue['project_id']);
            $pdo->prepare("UPDATE issues SET sprint_id = NULL WHERE id = ?")->execute([$issue_id]);
            print json_encode(['success' => true]);
        })(),

        default => print json_encode(['success' => false, 'error' => 'Acción no válida'])
    };
    exit;
}
```

**Step 2: Verify PHP syntax**

Run: `php -l app/api/sprints.php`
Expected: `No syntax errors detected`

**Step 3: Commit**

```bash
git add app/api/sprints.php
git commit -m "feat: sprints API (list, get, backlog, create, update, start, complete, delete, add/remove issue)"
```

---

### Task 3: Sprint page + JS

**Files:**
- Create: `app/pages/sprint.php`
- Create: `app/assets/js/sprint.js`

**Step 1: Create app/pages/sprint.php**

```php
<?php
$page_title = 'Sprint';
require __DIR__ . '/../includes/layout_top.php';
?>
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem;">
    <div>
        <h2 style="margin:0;" id="sprint-title">Sprint</h2>
        <span id="sprint-dates" style="font-size:0.85rem;color:var(--text-secondary);"></span>
    </div>
    <button class="btn btn-secondary" id="manage-sprints-btn">&#9881; Gestionar sprints</button>
</div>

<div id="sprint-kanban-wrap">
    <div style="padding:3rem;text-align:center;color:var(--text-secondary);">Cargando...</div>
</div>

<!-- Backlog section -->
<div style="margin-top:1.5rem;">
    <h4 style="margin:0 0 0.75rem;font-size:0.95rem;color:var(--text-primary);">&#128203; Backlog</h4>
    <div id="sprint-backlog" class="card" style="padding:0;"></div>
</div>

<!-- Sprint management modal -->
<div id="sprint-modal" class="modal hidden">
    <div class="modal-box" style="max-width:560px;max-height:80vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <h3 style="margin:0;">Gestionar sprints</h3>
            <button id="sprint-modal-close" style="background:none;border:none;font-size:1.25rem;cursor:pointer;color:var(--text-secondary);">&#10005;</button>
        </div>
        <!-- Create / edit form -->
        <div style="background:var(--bg-secondary,#f9fafb);border:1px solid var(--border);border-radius:8px;padding:1rem;margin-bottom:1rem;">
            <h4 style="margin:0 0 0.75rem;font-size:0.875rem;color:var(--text-primary);" id="sprint-form-title">Nuevo sprint</h4>
            <input type="text" id="sprint-name-input" placeholder="Nombre del sprint"
                style="width:100%;padding:0.4rem 0.6rem;border:1px solid var(--border);border-radius:4px;margin-bottom:0.5rem;font-size:0.875rem;background:var(--bg-card);color:var(--text-primary);box-sizing:border-box;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-bottom:0.5rem;">
                <input type="date" id="sprint-start-input"
                    style="padding:0.4rem 0.6rem;border:1px solid var(--border);border-radius:4px;font-size:0.875rem;background:var(--bg-card);color:var(--text-primary);">
                <input type="date" id="sprint-end-input"
                    style="padding:0.4rem 0.6rem;border:1px solid var(--border);border-radius:4px;font-size:0.875rem;background:var(--bg-card);color:var(--text-primary);">
            </div>
            <div style="display:flex;gap:0.5rem;">
                <button class="btn btn-primary" id="sprint-save-btn" style="font-size:0.875rem;">+ Crear sprint</button>
                <button class="btn btn-secondary" id="sprint-cancel-edit-btn" style="font-size:0.875rem;display:none;">Cancelar</button>
            </div>
        </div>
        <!-- Sprint list -->
        <div id="sprint-list-modal"></div>
    </div>
</div>

<script>
const PROJECT_ID = parseInt(localStorage.getItem('active_project_id') || '0');
</script>
<script src="<?= APP_URL ?>/app/assets/js/sprint.js"></script>
<?php require __DIR__ . '/../includes/layout_bottom.php'; ?>
```

**Step 2: Create app/assets/js/sprint.js**

```js
const SPRINT_COLS = ['todo', 'in_progress', 'review', 'done'];
const SPRINT_COL_LABELS = { todo: 'Pendiente', in_progress: 'En curso', review: 'Revisión', done: 'Hecho' };
let activeSprint = null;

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// ─── Sprint page load ─────────────────────────────────────────────────────────

async function loadSprintPage() {
    if (!PROJECT_ID) {
        document.getElementById('sprint-kanban-wrap').innerHTML =
            '<div style="padding:2rem;text-align:center;color:var(--text-secondary);">Selecciona un proyecto en el menú lateral.</div>';
        return;
    }
    try {
        const res    = await fetch(`${APP_URL}/app/api/sprints.php?action=list&project_id=${PROJECT_ID}`);
        const data   = await res.json();
        const sprints = data.data || [];
        activeSprint  = sprints.find(s => s.status === 'active') || null;

        if (!activeSprint) {
            renderNoActiveSprint();
        } else {
            const sRes  = await fetch(`${APP_URL}/app/api/sprints.php?action=get&id=${activeSprint.id}`);
            const sData = await sRes.json();
            activeSprint = sData.data;
            renderSprintHeader(activeSprint);
            renderSprintKanban(activeSprint.issues || []);
        }
    } catch(e) {
        document.getElementById('sprint-kanban-wrap').innerHTML =
            '<div style="padding:2rem;text-align:center;color:var(--text-secondary);">Error al cargar el sprint.</div>';
    }
    loadBacklog();
}

function renderNoActiveSprint() {
    document.getElementById('sprint-title').textContent = 'Sprint';
    document.getElementById('sprint-dates').textContent = '';
    document.getElementById('sprint-kanban-wrap').innerHTML = `
        <div class="card" style="padding:3rem;text-align:center;color:var(--text-secondary);">
            <div style="font-size:1.5rem;margin-bottom:0.5rem;">&#9654;</div>
            <p style="margin:0 0 1rem;">No hay ningún sprint activo.</p>
            <button class="btn btn-primary" onclick="openSprintModal()">Crear sprint</button>
        </div>`;
}

function renderSprintHeader(sprint) {
    document.getElementById('sprint-title').textContent = sprint.name;
    const [, sm, sd] = sprint.start_date.split('-');
    const [, em, ed] = sprint.end_date.split('-');
    document.getElementById('sprint-dates').textContent = `${sd}/${sm} – ${ed}/${em}`;
}

// ─── Sprint Kanban ─────────────────────────────────────────────────────────────

function renderSprintKanban(issues) {
    const wrap = document.getElementById('sprint-kanban-wrap');
    wrap.innerHTML = '';
    const board = document.createElement('div');
    board.className = 'kanban-board';
    board.id = 'sprint-board';

    SPRINT_COLS.forEach(col => {
        const colEl = document.createElement('div');
        colEl.className = 'kanban-col';
        colEl.dataset.status = col;
        const colIssues = issues.filter(i => i.status === col);
        colEl.innerHTML = `<div class="kanban-col-header">${SPRINT_COL_LABELS[col]} <span class="col-count">${colIssues.length}</span></div>`;
        if (!colIssues.length) colEl.innerHTML += '<div class="kanban-empty">Sin issues</div>';
        colIssues.forEach(issue => colEl.appendChild(buildSprintCard(issue)));

        colEl.addEventListener('dragover', e => { e.preventDefault(); colEl.classList.add('drag-over'); });
        colEl.addEventListener('dragleave', e => { if (!colEl.contains(e.relatedTarget)) colEl.classList.remove('drag-over'); });
        colEl.addEventListener('drop', async e => {
            e.preventDefault();
            colEl.classList.remove('drag-over');
            try {
                const parsed = JSON.parse(e.dataTransfer.getData('text/plain'));
                if (parsed.type === 'backlog-issue') {
                    await apiFetch(`${APP_URL}/app/api/sprints.php?action=add_issue`, { sprint_id: activeSprint.id, issue_id: parsed.id });
                    if (col !== 'todo') {
                        await apiFetch(`${APP_URL}/app/api/issues.php?action=update`, { id: parsed.id, status: col });
                    }
                    loadSprintPage();
                } else if (parsed.type === 'sprint-issue' && parsed.status !== col) {
                    await apiFetch(`${APP_URL}/app/api/issues.php?action=update`, { id: parsed.id, status: col });
                    loadSprintPage();
                }
            } catch(err) {}
        });
        board.appendChild(colEl);
    });
    wrap.appendChild(board);
}

function buildSprintCard(issue) {
    const card = document.createElement('div');
    card.className = 'kanban-card';
    card.draggable = true;
    const today = new Date(); today.setHours(0,0,0,0);
    const isOverdue = issue.due_date && new Date(issue.due_date + 'T00:00:00') < today && issue.status !== 'done';
    if (isOverdue) card.classList.add('overdue');
    const typeChip = issue.type_name
        ? `<span class="badge" style="background:${escapeHtml(issue.type_color||'#6b7280')}22;color:${escapeHtml(issue.type_color||'#6b7280')};border:1px solid ${escapeHtml(issue.type_color||'#6b7280')}44;font-size:0.65rem;padding:0.1rem 0.35rem;">${escapeHtml(issue.type_name)}</span>`
        : '';
    card.innerHTML = `
        ${typeChip ? `<div style="margin-bottom:0.3rem;">${typeChip}</div>` : ''}
        <div class="card-title">${escapeHtml(issue.title)}</div>
        <div class="card-meta">
            <span class="badge badge-${issue.priority}">${issue.priority}</span>
            ${issue.assignee_name ? `<span>${escapeHtml(issue.assignee_name)}</span>` : ''}
        </div>
        ${issue.story_points ? `<div style="font-size:0.7rem;color:var(--text-secondary);margin-top:0.2rem;text-align:right;">${issue.story_points} pts</div>` : ''}
        <div style="margin-top:0.4rem;text-align:right;">
            <button style="font-size:0.65rem;padding:0.1rem 0.35rem;background:var(--bg-secondary,#f3f4f6);color:var(--text-secondary);border:1px solid var(--border);border-radius:3px;cursor:pointer;"
                data-remove-issue="${issue.id}">← Backlog</button>
        </div>`;
    card.querySelector('[data-remove-issue]').addEventListener('click', e => {
        e.stopPropagation();
        removeIssueFromSprint(issue.id);
    });
    card.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'sprint-issue', id: issue.id, status: issue.status }));
    });
    card.addEventListener('click', e => {
        if (e.target.closest('button,[data-remove-issue]')) return;
        window.location.href = `${APP_URL}?page=issues&open_issue=${issue.id}`;
    });
    return card;
}

async function removeIssueFromSprint(issueId) {
    const res = await apiFetch(`${APP_URL}/app/api/sprints.php?action=remove_issue`, { issue_id: issueId });
    if (!res.success) { showToast(res.error || 'Error', 'error'); return; }
    loadSprintPage();
}

// ─── Backlog ──────────────────────────────────────────────────────────────────

async function loadBacklog() {
    const backlogEl = document.getElementById('sprint-backlog');
    if (!PROJECT_ID || !backlogEl) return;
    try {
        const res  = await fetch(`${APP_URL}/app/api/sprints.php?action=backlog&project_id=${PROJECT_ID}`);
        const data = await res.json();
        const items = data.data || [];

        if (!items.length) {
            backlogEl.innerHTML = '<div style="padding:1.5rem;text-align:center;color:var(--text-secondary);font-size:0.875rem;">Backlog vacío ✓</div>';
            return;
        }

        backlogEl.innerHTML = items.map(issue => {
            const typeChip = issue.type_name
                ? `<span class="badge" style="background:${escapeHtml(issue.type_color||'#6b7280')}22;color:${escapeHtml(issue.type_color||'#6b7280')};border:1px solid ${escapeHtml(issue.type_color||'#6b7280')}44;font-size:0.65rem;">${escapeHtml(issue.type_name)}</span>`
                : '';
            const addBtn = activeSprint
                ? `<button class="btn btn-secondary" style="font-size:0.75rem;padding:0.2rem 0.5rem;flex-shrink:0;"
                    data-add-issue="${issue.id}">→ Sprint</button>`
                : '';
            return `<div class="backlog-row" draggable="true" data-issue-id="${issue.id}"
                style="display:flex;align-items:center;gap:0.75rem;padding:0.65rem 1rem;border-bottom:1px solid var(--border);">
                <div style="flex:1;min-width:0;">
                    <div style="font-size:0.875rem;font-weight:500;">#${issue.id} ${escapeHtml(issue.title)}</div>
                    <div style="display:flex;gap:0.3rem;margin-top:0.2rem;flex-wrap:wrap;align-items:center;">
                        ${typeChip}
                        <span class="badge badge-${issue.priority}" style="font-size:0.65rem;">${issue.priority}</span>
                        ${issue.assignee_name ? `<span style="font-size:0.75rem;color:var(--text-secondary);">${escapeHtml(issue.assignee_name)}</span>` : ''}
                        ${issue.story_points ? `<span style="font-size:0.75rem;color:var(--text-secondary);">${issue.story_points} pts</span>` : ''}
                    </div>
                </div>
                ${addBtn}
            </div>`;
        }).join('');

        backlogEl.querySelectorAll('[data-add-issue]').forEach(btn => {
            btn.addEventListener('click', () => addIssueToSprint(parseInt(btn.dataset.addIssue)));
        });
        backlogEl.querySelectorAll('.backlog-row').forEach(row => {
            row.addEventListener('dragstart', e => {
                e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'backlog-issue', id: parseInt(row.dataset.issueId) }));
            });
        });
    } catch(e) {}
}

async function addIssueToSprint(issueId) {
    if (!activeSprint) { showToast('No hay sprint activo', 'warning'); return; }
    const res = await apiFetch(`${APP_URL}/app/api/sprints.php?action=add_issue`, { sprint_id: activeSprint.id, issue_id: issueId });
    if (!res.success) { showToast(res.error || 'Error', 'error'); return; }
    loadSprintPage();
}

// ─── Sprint management modal ──────────────────────────────────────────────────

let editingSprintId = null;

function openSprintModal() {
    document.getElementById('sprint-modal').classList.remove('hidden');
    loadSprintListModal();
}

function closeSprintModal() {
    document.getElementById('sprint-modal').classList.add('hidden');
    cancelEditSprint();
}

function cancelEditSprint() {
    editingSprintId = null;
    document.getElementById('sprint-form-title').textContent  = 'Nuevo sprint';
    document.getElementById('sprint-save-btn').textContent    = '+ Crear sprint';
    document.getElementById('sprint-cancel-edit-btn').style.display = 'none';
    document.getElementById('sprint-name-input').value  = '';
    document.getElementById('sprint-start-input').value = '';
    document.getElementById('sprint-end-input').value   = '';
}

async function loadSprintListModal() {
    const listEl = document.getElementById('sprint-list-modal');
    listEl.innerHTML = '<div style="padding:1rem;text-align:center;color:var(--text-secondary);">Cargando...</div>';
    const res    = await fetch(`${APP_URL}/app/api/sprints.php?action=list&project_id=${PROJECT_ID}`);
    const data   = await res.json();
    const sprints = data.data || [];

    if (!sprints.length) {
        listEl.innerHTML = '<div style="padding:1rem;text-align:center;color:var(--text-secondary);font-size:0.875rem;">No hay sprints aún</div>';
        return;
    }

    const STATUS_LABEL = { planning: 'Planificando', active: 'Activo', completed: 'Completado' };
    const STATUS_COLOR = { planning: '#d97706', active: '#16a34a', completed: '#6b7280' };

    listEl.innerHTML = sprints.map(s => {
        const [, sm, sd] = s.start_date.split('-');
        const [, em, ed] = s.end_date.split('-');
        const dateStr = `${sd}/${sm} – ${ed}/${em}`;
        let actions = '';
        if (s.status === 'planning') {
            actions = `
                <button class="btn btn-primary" style="font-size:0.75rem;" data-start-sprint="${s.id}">▶ Iniciar</button>
                <button class="btn btn-secondary" style="font-size:0.75rem;"
                    data-edit-sprint="${s.id}"
                    data-edit-name="${escapeHtml(s.name)}"
                    data-edit-start="${s.start_date}"
                    data-edit-end="${s.end_date}">Editar</button>
                <button class="btn btn-danger" style="font-size:0.75rem;" data-delete-sprint="${s.id}">Eliminar</button>`;
        } else if (s.status === 'active') {
            actions = `<button class="btn btn-secondary" style="font-size:0.75rem;" data-complete-sprint="${s.id}">&#10003; Cerrar sprint</button>`;
        }
        return `<div style="padding:0.75rem;border:1px solid var(--border);border-radius:8px;margin-bottom:0.5rem;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.5rem;flex-wrap:wrap;">
                <div>
                    <div style="font-weight:600;font-size:0.9rem;color:var(--text-primary);">${escapeHtml(s.name)}</div>
                    <div style="font-size:0.75rem;color:var(--text-secondary);">${dateStr} · ${s.issue_count} issues</div>
                </div>
                <span style="font-size:0.75rem;color:${STATUS_COLOR[s.status]};font-weight:600;">${STATUS_LABEL[s.status]}</span>
            </div>
            ${actions ? `<div style="display:flex;gap:0.4rem;flex-wrap:wrap;margin-top:0.5rem;">${actions}</div>` : ''}
        </div>`;
    }).join('');

    listEl.querySelectorAll('[data-start-sprint]').forEach(btn =>
        btn.addEventListener('click', () => startSprint(parseInt(btn.dataset.startSprint))));
    listEl.querySelectorAll('[data-complete-sprint]').forEach(btn =>
        btn.addEventListener('click', () => completeSprint(parseInt(btn.dataset.completeSprint))));
    listEl.querySelectorAll('[data-delete-sprint]').forEach(btn =>
        btn.addEventListener('click', () => deleteSprint(parseInt(btn.dataset.deleteSprint))));
    listEl.querySelectorAll('[data-edit-sprint]').forEach(btn =>
        btn.addEventListener('click', () => {
            editingSprintId = parseInt(btn.dataset.editSprint);
            document.getElementById('sprint-form-title').textContent = 'Editar sprint';
            document.getElementById('sprint-save-btn').textContent   = 'Guardar cambios';
            document.getElementById('sprint-cancel-edit-btn').style.display = '';
            document.getElementById('sprint-name-input').value  = btn.dataset.editName;
            document.getElementById('sprint-start-input').value = btn.dataset.editStart;
            document.getElementById('sprint-end-input').value   = btn.dataset.editEnd;
            document.getElementById('sprint-name-input').focus();
        }));
}

async function startSprint(id) {
    const res = await apiFetch(`${APP_URL}/app/api/sprints.php?action=start`, { id });
    if (!res.success) { showToast(res.error || 'Error', 'error'); return; }
    showToast('Sprint iniciado', 'success');
    loadSprintListModal();
    loadSprintPage();
}

function completeSprint(id) {
    showConfirm(
        '¿Cerrar este sprint? Las issues no completadas volverán al backlog.',
        async () => {
            const res = await apiFetch(`${APP_URL}/app/api/sprints.php?action=complete`, { id });
            if (!res.success) { showToast(res.error || 'Error', 'error'); return; }
            showToast('Sprint cerrado', 'success');
            loadSprintListModal();
            loadSprintPage();
        }
    );
}

function deleteSprint(id) {
    showConfirm(
        '¿Eliminar este sprint? Esta acción es irreversible.',
        async () => {
            const res = await apiFetch(`${APP_URL}/app/api/sprints.php?action=delete`, { id });
            if (!res.success) { showToast(res.error || 'Error', 'error'); return; }
            showToast('Sprint eliminado', 'success');
            loadSprintListModal();
            loadSprintPage();
        },
        { requireWord: 'ELIMINAR' }
    );
}

// ─── Event listeners ──────────────────────────────────────────────────────────

document.getElementById('manage-sprints-btn').addEventListener('click', openSprintModal);
document.getElementById('sprint-modal-close').addEventListener('click', closeSprintModal);
document.getElementById('sprint-cancel-edit-btn').addEventListener('click', cancelEditSprint);

document.getElementById('sprint-modal').addEventListener('click', e => {
    if (e.target === document.getElementById('sprint-modal')) closeSprintModal();
});

document.getElementById('sprint-save-btn').addEventListener('click', async () => {
    const name  = document.getElementById('sprint-name-input').value.trim();
    const start = document.getElementById('sprint-start-input').value;
    const end   = document.getElementById('sprint-end-input').value;
    if (!name || !start || !end) { showToast('Completa todos los campos', 'warning'); return; }

    let res;
    if (editingSprintId) {
        res = await apiFetch(`${APP_URL}/app/api/sprints.php?action=update`, { id: editingSprintId, name, start_date: start, end_date: end });
    } else {
        res = await apiFetch(`${APP_URL}/app/api/sprints.php?action=create`, { project_id: PROJECT_ID, name, start_date: start, end_date: end });
    }
    if (!res.success) { showToast(res.error || 'Error', 'error'); return; }
    showToast(editingSprintId ? 'Sprint actualizado' : 'Sprint creado', 'success');
    cancelEditSprint();
    loadSprintListModal();
    if (!editingSprintId) loadSprintPage();
});

// ─── Init ─────────────────────────────────────────────────────────────────────

if (PROJECT_ID) {
    loadSprintPage();
} else {
    document.getElementById('sprint-kanban-wrap').innerHTML =
        '<div style="padding:2rem;text-align:center;color:var(--text-secondary);">Selecciona un proyecto en el menú lateral.</div>';
    document.getElementById('sprint-backlog').innerHTML =
        '<div style="padding:1rem;text-align:center;color:var(--text-secondary);font-size:0.875rem;">Selecciona un proyecto para ver el backlog.</div>';
}
```

**Step 3: Verify PHP syntax**

Run: `php -l app/pages/sprint.php`
Expected: `No syntax errors detected`

**Step 4: Commit**

```bash
git add app/pages/sprint.php app/assets/js/sprint.js
git commit -m "feat: sprint page with kanban, backlog, and management modal"
```

---

### Task 4: Add Sprint link to sidebar

**Files:**
- Modify: `app/includes/layout_top.php:96-99`

**Step 1: Add Sprint link in sidebar**

In `app/includes/layout_top.php`, find the sidebar `<ul>` block (lines 92-100). Add the Sprint link after `kanban` and before `team`:

Old:
```html
            <li><a href="<?= APP_URL ?>?page=kanban">Kanban</a></li>
            <li><a href="<?= APP_URL ?>?page=team">Equipo</a></li>
```

New:
```html
            <li><a href="<?= APP_URL ?>?page=kanban">Kanban</a></li>
            <li style="display:flex;align-items:center;justify-content:space-between;">
                <a href="<?= APP_URL ?>?page=sprint" style="flex:1;">Sprint</a>
                <a href="<?= APP_URL ?>?page=sprint" onclick="event.preventDefault();setTimeout(()=>{if(window.openSprintModal)openSprintModal();},100);" title="Gestionar sprints" style="padding:0.1rem 0.3rem;font-size:0.75rem;color:var(--text-secondary);text-decoration:none;">&#9881;</a>
            </li>
            <li><a href="<?= APP_URL ?>?page=team">Equipo</a></li>
```

**Step 2: Register the sprint page in the router**

Open `public/index.php` and check how pages are routed. Read the file to find how to add 'sprint' as a valid page.

**Step 3: Add sprint to the router**

Read `public/index.php`. Find where pages are mapped (likely a match/switch on `$_GET['page']`). Add:

```php
'sprint' => 'app/pages/sprint.php',
```

**Step 4: Verify PHP syntax**

```bash
php -l app/includes/layout_top.php
php -l public/index.php
```

**Step 5: Commit**

```bash
git add app/includes/layout_top.php public/index.php
git commit -m "feat: add Sprint link to sidebar and router"
```

---

## After all tasks

```bash
git log --oneline -5
```

Expected: 4 new commits on master.

**Manual smoke test in Laragon (http://localhost/teamapp/public):**
1. Navigate to Sprint page — shows "No hay sprint activo"
2. Click "Gestionar sprints" — modal opens
3. Create a sprint with name + start/end dates — appears in list as "Planificando"
4. Click "Iniciar" — sprint becomes active, kanban appears
5. Sprint backlog shows issues without sprint
6. Click "→ Sprint" on a backlog issue — issue moves to kanban
7. Drag a kanban card to another column — status updates
8. Click "← Backlog" on a kanban card — card moves to backlog
9. Close sprint — non-done issues return to backlog, sprint shows as "Completado"
