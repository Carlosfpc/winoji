# WINOJI Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build an internal WINOJI combining Notion-style wiki, Jira-style task management, and GitHub integration using vanilla PHP, HTML/CSS/JS, and MySQL.

**Architecture:** Hybrid â€” PHP server-renders page shells; dynamic content (kanban, wiki, issues) loads via `fetch()` AJAX to PHP API endpoints. Auth via PHP sessions. All DB access via PDO prepared statements.

**Tech Stack:** PHP 8.x vanilla, MySQL 8.x, HTML/CSS/JavaScript vanilla, GitHub REST API via PHP cURL.

---

## Phase 1: Foundation

---

### Task 1: Create project folder structure

**Files:**
- Create: `public/index.php`
- Create: `config/config.php`
- Create: `app/includes/db.php`
- Create: `app/includes/auth.php`
- Create: `app/api/.gitkeep`
- Create: `app/pages/.gitkeep`
- Create: `app/assets/css/main.css`
- Create: `app/assets/js/.gitkeep`
- Create: `tests/.gitkeep`

**Step 1: Create all directories**

```bash
mkdir -p public config app/includes app/api app/pages app/assets/css app/assets/js tests
```

**Step 2: Create entry point `public/index.php`**

```php
<?php
session_start();
require_once __DIR__ . '/../config/config.php';
require_once __DIR__ . '/../app/includes/db.php';
require_once __DIR__ . '/../app/includes/auth.php';

$page = $_GET['page'] ?? 'login';
$allowed = ['login', 'dashboard', 'wiki', 'issues', 'kanban', 'team', 'profile'];

if (!in_array($page, $allowed)) {
    $page = '404';
}

$file = __DIR__ . '/../app/pages/' . $page . '.php';
if (!file_exists($file)) {
    http_response_code(404);
    echo "Page not found";
    exit;
}

require $file;
```

**Step 3: Create `config/config.php`**

```php
<?php
define('DB_HOST', 'localhost');
define('DB_NAME', 'teamapp');
define('DB_USER', 'root');
define('DB_PASS', '');
define('ENCRYPT_KEY', 'change-this-to-a-random-32-char-string');
define('APP_URL', 'http://localhost/teamapp/public');
```

**Step 4: Commit**

```bash
git add .
git commit -m "feat: scaffold project structure"
```

---

### Task 2: Create MySQL database schema

**Files:**
- Create: `db/schema.sql`
- Create: `tests/seed.sql`

**Step 1: Write `db/schema.sql`**

```sql
CREATE DATABASE IF NOT EXISTS teamapp CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE teamapp;

CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(150) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    avatar VARCHAR(255) DEFAULT NULL,
    github_token TEXT DEFAULT NULL,
    role ENUM('admin','member') NOT NULL DEFAULT 'member',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE team (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    logo VARCHAR(255) DEFAULT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE team_members (
    user_id INT NOT NULL,
    team_id INT NOT NULL,
    role ENUM('admin','member') NOT NULL DEFAULT 'member',
    PRIMARY KEY (user_id, team_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (team_id) REFERENCES team(id) ON DELETE CASCADE
);

CREATE TABLE pages (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    parent_id INT DEFAULT NULL,
    content LONGTEXT DEFAULT NULL,
    created_by INT NOT NULL,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id),
    FOREIGN KEY (parent_id) REFERENCES pages(id) ON DELETE SET NULL
);

CREATE TABLE page_versions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    page_id INT NOT NULL,
    content LONGTEXT,
    saved_by INT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (page_id) REFERENCES pages(id) ON DELETE CASCADE,
    FOREIGN KEY (saved_by) REFERENCES users(id)
);

CREATE TABLE projects (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(150) NOT NULL,
    description TEXT DEFAULT NULL,
    github_repo VARCHAR(255) DEFAULT NULL,
    created_by INT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

CREATE TABLE issues (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT NOT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT DEFAULT NULL,
    status ENUM('todo','in_progress','review','done') NOT NULL DEFAULT 'todo',
    priority ENUM('low','medium','high','critical') NOT NULL DEFAULT 'medium',
    assigned_to INT DEFAULT NULL,
    created_by INT NOT NULL,
    due_date DATE DEFAULT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
    FOREIGN KEY (assigned_to) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

CREATE TABLE labels (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    color VARCHAR(7) NOT NULL DEFAULT '#888888',
    project_id INT NOT NULL,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);

CREATE TABLE issue_labels (
    issue_id INT NOT NULL,
    label_id INT NOT NULL,
    PRIMARY KEY (issue_id, label_id),
    FOREIGN KEY (issue_id) REFERENCES issues(id) ON DELETE CASCADE,
    FOREIGN KEY (label_id) REFERENCES labels(id) ON DELETE CASCADE
);

CREATE TABLE comments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    issue_id INT NOT NULL,
    user_id INT NOT NULL,
    content TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (issue_id) REFERENCES issues(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE TABLE github_repos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT NOT NULL UNIQUE,
    repo_full_name VARCHAR(255) NOT NULL,
    access_token TEXT NOT NULL,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);

CREATE TABLE branches (
    id INT AUTO_INCREMENT PRIMARY KEY,
    issue_id INT NOT NULL,
    branch_name VARCHAR(255) NOT NULL,
    created_by INT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (issue_id) REFERENCES issues(id) ON DELETE CASCADE,
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

**Step 2: Write `tests/seed.sql`**

```sql
USE teamapp;

INSERT INTO team (name) VALUES ('My Team');

INSERT INTO users (name, email, password_hash, role)
VALUES ('Admin User', 'admin@example.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'admin');
-- password: password

INSERT INTO team_members (user_id, team_id, role) VALUES (1, 1, 'admin');

INSERT INTO projects (name, description, created_by) VALUES ('Demo Project', 'A demo project', 1);

INSERT INTO issues (project_id, title, description, status, priority, created_by)
VALUES
(1, 'First issue', 'This is a test issue', 'todo', 'medium', 1),
(1, 'Second issue', 'Another test issue', 'in_progress', 'high', 1);

INSERT INTO pages (title, content, created_by)
VALUES ('Welcome', '<h1>Welcome to the wiki</h1><p>Start writing here.</p>', 1);
```

**Step 3: Apply schema**

```bash
mysql -u root -p < db/schema.sql
mysql -u root -p teamapp < tests/seed.sql
```

Expected: No errors, tables created.

**Step 4: Commit**

```bash
git add db/schema.sql tests/seed.sql
git commit -m "feat: add database schema and seed data"
```

---

### Task 3: Database connection helper

**Files:**
- Modify: `app/includes/db.php`

**Step 1: Write failing test `tests/test_db.php`**

```php
<?php
require_once __DIR__ . '/../config/config.php';
require_once __DIR__ . '/../app/includes/db.php';

$pdo = get_db();
assert($pdo instanceof PDO, 'get_db() should return a PDO instance');

$stmt = $pdo->query("SELECT 1");
assert($stmt !== false, 'Should be able to execute a query');

echo "PASS: DB connection works\n";
```

**Step 2: Run test to verify it fails**

```bash
php tests/test_db.php
```

Expected: FAIL â€” `get_db()` not defined.

**Step 3: Write `app/includes/db.php`**

```php
<?php
function get_db(): PDO {
    static $pdo = null;
    if ($pdo === null) {
        $dsn = 'mysql:host=' . DB_HOST . ';dbname=' . DB_NAME . ';charset=utf8mb4';
        $pdo = new PDO($dsn, DB_USER, DB_PASS, [
            PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
            PDO::ATTR_EMULATE_PREPARES   => false,
        ]);
    }
    return $pdo;
}
```

**Step 4: Run test to verify it passes**

```bash
php tests/test_db.php
```

Expected: `PASS: DB connection works`

**Step 5: Commit**

```bash
git add app/includes/db.php tests/test_db.php
git commit -m "feat: add PDO database connection helper"
```

---

## Phase 2: Auth

---

### Task 4: Login endpoint and page

**Files:**
- Create: `app/api/auth.php`
- Create: `app/pages/login.php`

**Step 1: Write failing test `tests/test_auth.php`**

```php
<?php
require_once __DIR__ . '/../config/config.php';
require_once __DIR__ . '/../app/includes/db.php';
require_once __DIR__ . '/../app/api/auth.php';

// Test login with valid credentials
$result = attempt_login('admin@example.com', 'password');
assert($result['success'] === true, 'Valid login should succeed');
assert(isset($result['user']['id']), 'Should return user data');

// Test login with invalid credentials
$result2 = attempt_login('admin@example.com', 'wrong');
assert($result2['success'] === false, 'Invalid login should fail');

echo "PASS: Auth login logic works\n";
```

**Step 2: Run test to verify it fails**

```bash
php tests/test_auth.php
```

Expected: FAIL â€” `attempt_login()` not defined.

**Step 3: Write `app/api/auth.php`**

```php
<?php
function attempt_login(string $email, string $password): array {
    $pdo = get_db();
    $stmt = $pdo->prepare('SELECT * FROM users WHERE email = ?');
    $stmt->execute([$email]);
    $user = $stmt->fetch();

    if (!$user || !password_verify($password, $user['password_hash'])) {
        return ['success' => false, 'error' => 'Invalid email or password'];
    }

    return ['success' => true, 'user' => [
        'id'    => $user['id'],
        'name'  => $user['name'],
        'email' => $user['email'],
        'role'  => $user['role'],
    ]];
}

// Handle POST login request
if ($_SERVER['REQUEST_METHOD'] === 'POST' && ($_GET['action'] ?? '') === 'login') {
    header('Content-Type: application/json');
    $body = json_decode(file_get_contents('php://input'), true);
    $result = attempt_login($body['email'] ?? '', $body['password'] ?? '');

    if ($result['success']) {
        session_regenerate_id(true);
        $_SESSION['user'] = $result['user'];
    }

    echo json_encode($result);
    exit;
}

// Handle POST logout request
if ($_SERVER['REQUEST_METHOD'] === 'POST' && ($_GET['action'] ?? '') === 'logout') {
    header('Content-Type: application/json');
    session_destroy();
    echo json_encode(['success' => true]);
    exit;
}
```

**Step 4: Write `app/pages/login.php`**

```php
<?php
if (isset($_SESSION['user'])) {
    header('Location: ' . APP_URL . '?page=dashboard');
    exit;
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Login â€” WINOJI</title>
    <link rel="stylesheet" href="<?= APP_URL ?>/app/assets/css/main.css">
</head>
<body class="auth-page">
    <div class="auth-box">
        <h1>WINOJI</h1>
        <form id="login-form">
            <label>Email</label>
            <input type="email" id="email" required>
            <label>Password</label>
            <input type="password" id="password" required>
            <button type="submit">Login</button>
            <p id="error-msg" class="error hidden"></p>
        </form>
    </div>
    <script>
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const res = await fetch('<?= APP_URL ?>/app/api/auth.php?action=login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            })
        });
        const data = await res.json();
        if (data.success) {
            window.location.href = '<?= APP_URL ?>?page=dashboard';
        } else {
            const err = document.getElementById('error-msg');
            err.textContent = data.error;
            err.classList.remove('hidden');
        }
    });
    </script>
</body>
</html>
```

**Step 5: Run test to verify it passes**

```bash
php tests/test_auth.php
```

Expected: `PASS: Auth login logic works`

**Step 6: Commit**

```bash
git add app/api/auth.php app/pages/login.php tests/test_auth.php
git commit -m "feat: add login endpoint and login page"
```

---

### Task 5: Auth middleware

**Files:**
- Modify: `app/includes/auth.php`

**Step 1: Write failing test `tests/test_middleware.php`**

```php
<?php
require_once __DIR__ . '/../config/config.php';
require_once __DIR__ . '/../app/includes/auth.php';

// Test: not logged in
$_SESSION = [];
$result = is_authenticated();
assert($result === false, 'Should return false when not authenticated');

// Test: logged in
$_SESSION['user'] = ['id' => 1, 'role' => 'admin'];
$result = is_authenticated();
assert($result === true, 'Should return true when authenticated');

// Test: role check
assert(has_role('admin') === true, 'Admin should have admin role');
assert(has_role('member') === true, 'Admin should also pass member check');

$_SESSION['user']['role'] = 'member';
assert(has_role('admin') === false, 'Member should not have admin role');

echo "PASS: Auth middleware works\n";
```

**Step 2: Run test to verify it fails**

```bash
php tests/test_middleware.php
```

Expected: FAIL â€” `is_authenticated()` not defined.

**Step 3: Write `app/includes/auth.php`**

```php
<?php
function is_authenticated(): bool {
    return isset($_SESSION['user']['id']);
}

function has_role(string $role): bool {
    if (!is_authenticated()) return false;
    $user_role = $_SESSION['user']['role'];
    if ($role === 'member') return true; // all roles pass member check
    return $user_role === $role;
}

function require_auth(): void {
    if (!is_authenticated()) {
        if (str_contains($_SERVER['REQUEST_URI'] ?? '', '/api/')) {
            header('Content-Type: application/json');
            http_response_code(401);
            echo json_encode(['success' => false, 'error' => 'Unauthorized']);
            exit;
        }
        header('Location: ' . APP_URL . '?page=login');
        exit;
    }
}

function require_role(string $role): void {
    require_auth();
    if (!has_role($role)) {
        header('Content-Type: application/json');
        http_response_code(403);
        echo json_encode(['success' => false, 'error' => 'Forbidden']);
        exit;
    }
}

function current_user(): ?array {
    return $_SESSION['user'] ?? null;
}
```

**Step 4: Run test to verify it passes**

```bash
php tests/test_middleware.php
```

Expected: `PASS: Auth middleware works`

**Step 5: Commit**

```bash
git add app/includes/auth.php tests/test_middleware.php
git commit -m "feat: add auth middleware with role checks"
```

---

## Phase 3: UI Shell

---

### Task 6: Main layout and CSS foundation

**Files:**
- Create: `app/includes/layout_top.php`
- Create: `app/includes/layout_bottom.php`
- Modify: `app/assets/css/main.css`
- Create: `app/pages/dashboard.php`

**Step 1: Write `app/includes/layout_top.php`**

```php
<?php require_auth(); ?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title><?= htmlspecialchars($page_title ?? 'WINOJI') ?></title>
    <link rel="stylesheet" href="<?= APP_URL ?>/app/assets/css/main.css">
</head>
<body>
<div class="app-layout">
    <nav class="sidebar">
        <div class="sidebar-logo">WINOJI</div>
        <ul>
            <li><a href="<?= APP_URL ?>?page=dashboard">Dashboard</a></li>
            <li><a href="<?= APP_URL ?>?page=wiki">Wiki</a></li>
            <li><a href="<?= APP_URL ?>?page=issues">Issues</a></li>
            <li><a href="<?= APP_URL ?>?page=kanban">Kanban</a></li>
            <li><a href="<?= APP_URL ?>?page=team">Team</a></li>
        </ul>
        <div class="sidebar-user">
            <span><?= htmlspecialchars(current_user()['name']) ?></span>
            <button id="logout-btn">Logout</button>
        </div>
    </nav>
    <main class="main-content">
```

**Step 2: Write `app/includes/layout_bottom.php`**

```php
    </main>
</div>
<script>
document.getElementById('logout-btn').addEventListener('click', async () => {
    await fetch('<?= APP_URL ?>/app/api/auth.php?action=logout', { method: 'POST' });
    window.location.href = '<?= APP_URL ?>?page=login';
});
</script>
</body>
</html>
```

**Step 3: Write `app/assets/css/main.css`** (base styles)

```css
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; color: #333; }

/* Layout */
.app-layout { display: flex; min-height: 100vh; }
.sidebar { width: 220px; background: #1a1a2e; color: #ccc; display: flex; flex-direction: column; padding: 1rem; flex-shrink: 0; }
.sidebar-logo { font-size: 1.2rem; font-weight: bold; color: #fff; margin-bottom: 1.5rem; }
.sidebar ul { list-style: none; flex: 1; }
.sidebar ul li a { display: block; padding: 0.5rem 0.75rem; color: #ccc; text-decoration: none; border-radius: 4px; margin-bottom: 0.25rem; }
.sidebar ul li a:hover { background: #2a2a4a; color: #fff; }
.sidebar-user { border-top: 1px solid #333; padding-top: 1rem; font-size: 0.85rem; }
.sidebar-user button { margin-top: 0.5rem; background: transparent; border: 1px solid #555; color: #aaa; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; width: 100%; }

.main-content { flex: 1; padding: 2rem; overflow-y: auto; }

/* Auth */
.auth-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
.auth-box { background: #fff; padding: 2rem; border-radius: 8px; width: 360px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
.auth-box h1 { margin-bottom: 1.5rem; }
.auth-box label { display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.9rem; }
.auth-box input { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 1rem; font-size: 1rem; }
.auth-box button { width: 100%; padding: 0.6rem; background: #4f46e5; color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; }

/* Utilities */
.hidden { display: none !important; }
.error { color: #dc2626; font-size: 0.875rem; margin-top: 0.5rem; }
.btn { padding: 0.5rem 1rem; border-radius: 4px; border: none; cursor: pointer; font-size: 0.9rem; }
.btn-primary { background: #4f46e5; color: white; }
.btn-secondary { background: #e5e7eb; color: #333; }

/* Cards */
.card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 1rem; }
```

**Step 4: Write `app/pages/dashboard.php`**

```php
<?php
$page_title = 'Dashboard';
require __DIR__ . '/../includes/layout_top.php';
?>
<h2>Dashboard</h2>
<p>Welcome, <?= htmlspecialchars(current_user()['name']) ?>.</p>
<?php require __DIR__ . '/../includes/layout_bottom.php'; ?>
```

**Step 5: Verify in browser**

Visit: `http://localhost/teamapp/public/?page=login`
- Login with `admin@example.com` / `password`
- Should redirect to dashboard with sidebar visible

**Step 6: Commit**

```bash
git add app/includes/layout_top.php app/includes/layout_bottom.php app/assets/css/main.css app/pages/dashboard.php
git commit -m "feat: add app shell with sidebar layout and base CSS"
```

---

## Phase 4: Wiki

---

### Task 7: Pages CRUD API

**Files:**
- Create: `app/api/pages.php`
- Create: `tests/test_pages.php`

**Step 1: Write failing test**

```php
<?php
session_start();
require_once __DIR__ . '/../config/config.php';
require_once __DIR__ . '/../app/includes/db.php';
require_once __DIR__ . '/../app/includes/auth.php';
require_once __DIR__ . '/../app/api/pages.php';

$_SESSION['user'] = ['id' => 1, 'role' => 'admin'];

// Test create page
$result = create_page('Test Page', null, '<p>Hello</p>', 1);
assert($result['success'] === true, 'Should create page');
$page_id = $result['id'];

// Test get page
$page = get_page($page_id);
assert($page['title'] === 'Test Page', 'Should retrieve page');

// Test update page
$result2 = update_page($page_id, 'Updated Title', '<p>Updated</p>', 1);
assert($result2['success'] === true, 'Should update page');

// Test list pages
$pages = list_pages();
assert(is_array($pages), 'Should return array of pages');

// Cleanup
get_db()->exec("DELETE FROM pages WHERE id = $page_id");

echo "PASS: Pages CRUD works\n";
```

**Step 2: Run test to verify it fails**

```bash
php tests/test_pages.php
```

Expected: FAIL â€” functions not defined.

**Step 3: Write `app/api/pages.php`**

```php
<?php
function list_pages(): array {
    $pdo = get_db();
    $stmt = $pdo->query('SELECT id, title, parent_id, created_by, updated_at FROM pages ORDER BY created_at');
    return $stmt->fetchAll();
}

function get_page(int $id): ?array {
    $pdo = get_db();
    $stmt = $pdo->prepare('SELECT * FROM pages WHERE id = ?');
    $stmt->execute([$id]);
    return $stmt->fetch() ?: null;
}

function create_page(string $title, ?int $parent_id, string $content, int $user_id): array {
    $pdo = get_db();
    $stmt = $pdo->prepare('INSERT INTO pages (title, parent_id, content, created_by) VALUES (?, ?, ?, ?)');
    $stmt->execute([$title, $parent_id, $content, $user_id]);
    return ['success' => true, 'id' => (int)$pdo->lastInsertId()];
}

function update_page(int $id, string $title, string $content, int $user_id): array {
    $pdo = get_db();
    // Save version snapshot first
    $current = get_page($id);
    if ($current) {
        $pdo->prepare('INSERT INTO page_versions (page_id, content, saved_by) VALUES (?, ?, ?)')
            ->execute([$id, $current['content'], $user_id]);
    }
    $pdo->prepare('UPDATE pages SET title = ?, content = ? WHERE id = ?')
        ->execute([$title, $content, $id]);
    return ['success' => true];
}

function delete_page(int $id): array {
    get_db()->prepare('DELETE FROM pages WHERE id = ?')->execute([$id]);
    return ['success' => true];
}

// HTTP routing
if (php_sapi_name() !== 'cli') {
    require_auth();
    header('Content-Type: application/json');
    $method = $_SERVER['REQUEST_METHOD'];
    $action = $_GET['action'] ?? '';

    if ($method === 'GET' && $action === 'list') {
        echo json_encode(['success' => true, 'data' => list_pages()]);
    } elseif ($method === 'GET' && $action === 'get') {
        $page = get_page((int)($_GET['id'] ?? 0));
        echo json_encode($page ? ['success' => true, 'data' => $page] : ['success' => false, 'error' => 'Not found']);
    } elseif ($method === 'POST' && $action === 'create') {
        $b = json_decode(file_get_contents('php://input'), true);
        echo json_encode(create_page($b['title'], $b['parent_id'] ?? null, $b['content'] ?? '', current_user()['id']));
    } elseif ($method === 'POST' && $action === 'update') {
        $b = json_decode(file_get_contents('php://input'), true);
        echo json_encode(update_page((int)$b['id'], $b['title'], $b['content'], current_user()['id']));
    } elseif ($method === 'POST' && $action === 'delete') {
        $b = json_decode(file_get_contents('php://input'), true);
        echo json_encode(delete_page((int)$b['id']));
    }
    exit;
}
```

**Step 4: Run test to verify it passes**

```bash
php tests/test_pages.php
```

Expected: `PASS: Pages CRUD works`

**Step 5: Commit**

```bash
git add app/api/pages.php tests/test_pages.php
git commit -m "feat: add wiki pages CRUD API"
```

---

### Task 8: Wiki editor frontend page

**Files:**
- Create: `app/pages/wiki.php`
- Create: `app/assets/js/wiki.js`

**Step 1: Write `app/pages/wiki.php`**

```php
<?php
$page_title = 'Wiki';
require __DIR__ . '/../includes/layout_top.php';
?>
<div class="wiki-layout">
    <aside class="wiki-sidebar">
        <div class="wiki-sidebar-header">
            <strong>Pages</strong>
            <button class="btn btn-primary" id="new-page-btn" style="font-size:0.8rem;padding:0.3rem 0.6rem">+ New</button>
        </div>
        <ul id="pages-list"></ul>
    </aside>
    <div class="wiki-editor">
        <div id="editor-placeholder" style="color:#aaa;margin-top:2rem;">Select a page or create a new one.</div>
        <div id="editor-area" class="hidden">
            <input type="text" id="page-title" placeholder="Page title" style="width:100%;font-size:1.5rem;border:none;outline:none;margin-bottom:1rem;font-weight:bold;">
            <div class="editor-toolbar">
                <button onclick="execCmd('bold')"><b>B</b></button>
                <button onclick="execCmd('italic')"><i>I</i></button>
                <button onclick="execCmd('insertUnorderedList')">â€¢</button>
                <button onclick="insertCode()">{ }</button>
            </div>
            <div id="page-content" contenteditable="true" class="editor-content"></div>
            <div id="save-status" style="font-size:0.8rem;color:#aaa;margin-top:0.5rem;"></div>
        </div>
    </div>
</div>
<?php require __DIR__ . '/../includes/layout_bottom.php'; ?>
```

**Step 2: Write `app/assets/js/wiki.js`**

```javascript
const API = document.querySelector('meta[name="app-url"]')?.content || '';
let currentPageId = null;
let saveTimer = null;

async function loadPagesList() {
    const res = await fetch(`${APP_URL}/app/api/pages.php?action=list`);
    const data = await res.json();
    const ul = document.getElementById('pages-list');
    ul.innerHTML = '';
    (data.data || []).forEach(p => {
        const li = document.createElement('li');
        li.textContent = p.title;
        li.dataset.id = p.id;
        li.style.cssText = 'padding:0.4rem 0.75rem;cursor:pointer;border-radius:4px;';
        li.addEventListener('click', () => loadPage(p.id));
        ul.appendChild(li);
    });
}

async function loadPage(id) {
    const res = await fetch(`${APP_URL}/app/api/pages.php?action=get&id=${id}`);
    const data = await res.json();
    if (!data.success) return;
    currentPageId = id;
    document.getElementById('page-title').value = data.data.title;
    document.getElementById('page-content').innerHTML = data.data.content || '';
    document.getElementById('editor-placeholder').classList.add('hidden');
    document.getElementById('editor-area').classList.remove('hidden');
    scheduleSave();
}

function scheduleSave() {
    if (saveTimer) clearInterval(saveTimer);
    saveTimer = setInterval(savePage, 30000);
}

async function savePage() {
    if (!currentPageId) return;
    const title = document.getElementById('page-title').value;
    const content = document.getElementById('page-content').innerHTML;
    const res = await fetch(`${APP_URL}/app/api/pages.php?action=update`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: currentPageId, title, content })
    });
    const data = await res.json();
    document.getElementById('save-status').textContent = data.success ? 'Saved' : 'Error saving';
    await loadPagesList();
}

document.getElementById('new-page-btn').addEventListener('click', async () => {
    const title = prompt('Page title:');
    if (!title) return;
    const res = await fetch(`${APP_URL}/app/api/pages.php?action=create`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, content: '' })
    });
    const data = await res.json();
    if (data.success) {
        await loadPagesList();
        loadPage(data.id);
    }
});

function execCmd(cmd) { document.execCommand(cmd, false, null); }
function insertCode() { document.execCommand('insertHTML', false, '<code>code here</code>'); }

// Init
loadPagesList();
```

Note: Add `<script>const APP_URL = '<?= APP_URL ?>';</script>` and `<script src="<?= APP_URL ?>/app/assets/js/wiki.js"></script>` to `wiki.php` before the closing layout.

**Step 3: Add CSS for wiki layout to `main.css`**

```css
/* Wiki */
.wiki-layout { display: flex; gap: 1.5rem; height: calc(100vh - 4rem); }
.wiki-sidebar { width: 220px; background: white; border-radius: 8px; padding: 1rem; overflow-y: auto; flex-shrink: 0; }
.wiki-sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
.wiki-sidebar ul { list-style: none; }
.wiki-editor { flex: 1; background: white; border-radius: 8px; padding: 1.5rem; overflow-y: auto; }
.editor-toolbar button { background: #f3f4f6; border: 1px solid #e5e7eb; padding: 0.25rem 0.6rem; cursor: pointer; border-radius: 4px; margin-right: 0.25rem; }
.editor-content { min-height: 400px; outline: none; line-height: 1.7; }
```

**Step 4: Verify in browser**

Visit `?page=wiki`, create a page, edit it, verify auto-save fires after 30s.

**Step 5: Commit**

```bash
git add app/pages/wiki.php app/assets/js/wiki.js app/assets/css/main.css
git commit -m "feat: add wiki editor with auto-save"
```

---

## Phase 5: Issues & Kanban

---

### Task 9: Issues CRUD API

**Files:**
- Create: `app/api/issues.php`
- Create: `tests/test_issues.php`

**Step 1: Write failing test**

```php
<?php
session_start();
require_once __DIR__ . '/../config/config.php';
require_once __DIR__ . '/../app/includes/db.php';
require_once __DIR__ . '/../app/includes/auth.php';
require_once __DIR__ . '/../app/api/issues.php';

$_SESSION['user'] = ['id' => 1, 'role' => 'admin'];

$result = create_issue(1, 'Test Issue', 'Test body', 'todo', 'medium', null, null, 1);
assert($result['success'] === true, 'Should create issue');
$issue_id = $result['id'];

$issue = get_issue($issue_id);
assert($issue['title'] === 'Test Issue', 'Should get issue');

$result2 = update_issue_status($issue_id, 'in_progress');
assert($result2['success'] === true, 'Should update status');

$issues = list_issues(1);
assert(is_array($issues), 'Should list issues');

get_db()->exec("DELETE FROM issues WHERE id = $issue_id");
echo "PASS: Issues CRUD works\n";
```

**Step 2: Run test to verify it fails**

```bash
php tests/test_issues.php
```

**Step 3: Write `app/api/issues.php`**

```php
<?php
function list_issues(int $project_id, array $filters = []): array {
    $pdo = get_db();
    $sql = 'SELECT i.*, u.name as assignee_name FROM issues i LEFT JOIN users u ON i.assigned_to = u.id WHERE i.project_id = ?';
    $params = [$project_id];
    if (!empty($filters['status'])) { $sql .= ' AND i.status = ?'; $params[] = $filters['status']; }
    if (!empty($filters['priority'])) { $sql .= ' AND i.priority = ?'; $params[] = $filters['priority']; }
    if (!empty($filters['assigned_to'])) { $sql .= ' AND i.assigned_to = ?'; $params[] = $filters['assigned_to']; }
    $sql .= ' ORDER BY i.created_at DESC';
    $stmt = $pdo->prepare($sql);
    $stmt->execute($params);
    return $stmt->fetchAll();
}

function get_issue(int $id): ?array {
    $pdo = get_db();
    $stmt = $pdo->prepare('SELECT i.*, u.name as assignee_name FROM issues i LEFT JOIN users u ON i.assigned_to = u.id WHERE i.id = ?');
    $stmt->execute([$id]);
    return $stmt->fetch() ?: null;
}

function create_issue(int $project_id, string $title, ?string $desc, string $status, string $priority, ?int $assigned_to, ?string $due_date, int $user_id): array {
    $pdo = get_db();
    $stmt = $pdo->prepare('INSERT INTO issues (project_id, title, description, status, priority, assigned_to, due_date, created_by) VALUES (?,?,?,?,?,?,?,?)');
    $stmt->execute([$project_id, $title, $desc, $status, $priority, $assigned_to, $due_date, $user_id]);
    return ['success' => true, 'id' => (int)$pdo->lastInsertId()];
}

function update_issue(int $id, array $fields): array {
    $pdo = get_db();
    $allowed = ['title','description','status','priority','assigned_to','due_date'];
    $sets = []; $params = [];
    foreach ($allowed as $f) {
        if (array_key_exists($f, $fields)) { $sets[] = "$f = ?"; $params[] = $fields[$f]; }
    }
    if (empty($sets)) return ['success' => false, 'error' => 'No fields'];
    $params[] = $id;
    $pdo->prepare('UPDATE issues SET ' . implode(', ', $sets) . ' WHERE id = ?')->execute($params);
    return ['success' => true];
}

function update_issue_status(int $id, string $status): array {
    return update_issue($id, ['status' => $status]);
}

function delete_issue(int $id): array {
    get_db()->prepare('DELETE FROM issues WHERE id = ?')->execute([$id]);
    return ['success' => true];
}

// HTTP routing
if (php_sapi_name() !== 'cli') {
    require_auth();
    header('Content-Type: application/json');
    $method = $_SERVER['REQUEST_METHOD'];
    $action = $_GET['action'] ?? '';
    $b = $method === 'POST' ? json_decode(file_get_contents('php://input'), true) : [];

    match(true) {
        $method === 'GET' && $action === 'list'   => print json_encode(['success'=>true,'data'=>list_issues((int)($_GET['project_id']??0), $_GET)]),
        $method === 'GET' && $action === 'get'    => print json_encode(($i=get_issue((int)($_GET['id']??0))) ? ['success'=>true,'data'=>$i] : ['success'=>false,'error'=>'Not found']),
        $method === 'POST' && $action === 'create' => print json_encode(create_issue($b['project_id'], $b['title'], $b['description']??null, $b['status']??'todo', $b['priority']??'medium', $b['assigned_to']??null, $b['due_date']??null, current_user()['id'])),
        $method === 'POST' && $action === 'update' => print json_encode(update_issue((int)$b['id'], $b)),
        $method === 'POST' && $action === 'delete' => print json_encode(delete_issue((int)$b['id'])),
        default => null
    };
    exit;
}
```

**Step 4: Run test to verify it passes**

```bash
php tests/test_issues.php
```

Expected: `PASS: Issues CRUD works`

**Step 5: Commit**

```bash
git add app/api/issues.php tests/test_issues.php
git commit -m "feat: add issues CRUD API"
```

---

### Task 10: Kanban board frontend

**Files:**
- Create: `app/pages/kanban.php`
- Create: `app/assets/js/kanban.js`

**Step 1: Write `app/pages/kanban.php`**

```php
<?php
$page_title = 'Kanban';
require __DIR__ . '/../includes/layout_top.php';
?>
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
    <h2>Kanban Board</h2>
    <button class="btn btn-primary" id="new-issue-btn">+ New Issue</button>
</div>
<div id="kanban-board" class="kanban-board"></div>

<!-- New Issue Modal -->
<div id="issue-modal" class="modal hidden">
    <div class="modal-box">
        <h3>New Issue</h3>
        <input type="text" id="issue-title" placeholder="Title" style="width:100%;padding:0.5rem;margin-bottom:0.75rem;border:1px solid #ddd;border-radius:4px;">
        <textarea id="issue-desc" placeholder="Description" style="width:100%;padding:0.5rem;height:100px;border:1px solid #ddd;border-radius:4px;"></textarea>
        <div style="margin-top:1rem;display:flex;gap:0.5rem;justify-content:flex-end;">
            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
            <button class="btn btn-primary" id="modal-save">Create</button>
        </div>
    </div>
</div>

<script>const APP_URL = '<?= APP_URL ?>'; const PROJECT_ID = 1;</script>
<script src="<?= APP_URL ?>/app/assets/js/kanban.js"></script>
<?php require __DIR__ . '/../includes/layout_bottom.php'; ?>
```

**Step 2: Write `app/assets/js/kanban.js`**

```javascript
const COLUMNS = ['todo', 'in_progress', 'review', 'done'];
const COLUMN_LABELS = { todo: 'To Do', in_progress: 'In Progress', review: 'Review', done: 'Done' };
let issues = [];

async function loadIssues() {
    const res = await fetch(`${APP_URL}/app/api/issues.php?action=list&project_id=${PROJECT_ID}`);
    const data = await res.json();
    issues = data.data || [];
    renderBoard();
}

function renderBoard() {
    const board = document.getElementById('kanban-board');
    board.innerHTML = '';
    COLUMNS.forEach(col => {
        const colEl = document.createElement('div');
        colEl.className = 'kanban-col';
        colEl.dataset.status = col;
        colEl.innerHTML = `<div class="kanban-col-header">${COLUMN_LABELS[col]}</div>`;
        issues.filter(i => i.status === col).forEach(issue => {
            const card = document.createElement('div');
            card.className = 'kanban-card';
            card.draggable = true;
            card.dataset.id = issue.id;
            card.innerHTML = `<div class="card-title">${issue.title}</div>
                <div class="card-meta"><span class="badge badge-${issue.priority}">${issue.priority}</span>
                ${issue.assignee_name ? `<span>${issue.assignee_name}</span>` : ''}</div>`;
            card.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', issue.id));
            colEl.appendChild(card);
        });
        colEl.addEventListener('dragover', e => e.preventDefault());
        colEl.addEventListener('drop', async e => {
            e.preventDefault();
            const id = e.dataTransfer.getData('text/plain');
            await fetch(`${APP_URL}/app/api/issues.php?action=update`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ id: parseInt(id), status: col })
            });
            loadIssues();
        });
        board.appendChild(colEl);
    });
}

document.getElementById('new-issue-btn').addEventListener('click', () => {
    document.getElementById('issue-modal').classList.remove('hidden');
});
document.getElementById('modal-cancel').addEventListener('click', () => {
    document.getElementById('issue-modal').classList.add('hidden');
});
document.getElementById('modal-save').addEventListener('click', async () => {
    const title = document.getElementById('issue-title').value.trim();
    if (!title) return;
    await fetch(`${APP_URL}/app/api/issues.php?action=create`, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ project_id: PROJECT_ID, title, description: document.getElementById('issue-desc').value })
    });
    document.getElementById('issue-modal').classList.add('hidden');
    document.getElementById('issue-title').value = '';
    document.getElementById('issue-desc').value = '';
    loadIssues();
});

loadIssues();
```

**Step 3: Add Kanban CSS to `main.css`**

```css
/* Kanban */
.kanban-board { display: flex; gap: 1rem; overflow-x: auto; }
.kanban-col { min-width: 240px; background: #f3f4f6; border-radius: 8px; padding: 0.75rem; }
.kanban-col-header { font-weight: 600; margin-bottom: 0.75rem; font-size: 0.9rem; color: #555; }
.kanban-card { background: white; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; cursor: grab; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
.card-title { font-size: 0.9rem; margin-bottom: 0.5rem; }
.card-meta { display: flex; gap: 0.5rem; font-size: 0.75rem; color: #888; align-items: center; }
.badge { padding: 0.15rem 0.5rem; border-radius: 999px; font-size: 0.7rem; font-weight: 500; }
.badge-low { background: #dcfce7; color: #166534; }
.badge-medium { background: #fef9c3; color: #854d0e; }
.badge-high { background: #fee2e2; color: #991b1b; }
.badge-critical { background: #7f1d1d; color: white; }
/* Modal */
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 100; }
.modal-box { background: white; padding: 1.5rem; border-radius: 8px; width: 460px; }
```

**Step 4: Verify in browser**

Visit `?page=kanban`, drag cards between columns, create a new issue.

**Step 5: Commit**

```bash
git add app/pages/kanban.php app/assets/js/kanban.js app/assets/css/main.css
git commit -m "feat: add kanban board with drag-and-drop"
```

---

## Phase 6: GitHub Integration

---

### Task 11: Connect GitHub repo to project

**Files:**
- Create: `app/api/github.php`
- Create: `tests/test_github.php`

**Step 1: Write `app/api/github.php`** (helper functions)

```php
<?php
function encrypt_token(string $token): string {
    $iv = openssl_random_pseudo_bytes(16);
    $encrypted = openssl_encrypt($token, 'AES-256-CBC', ENCRYPT_KEY, 0, $iv);
    return base64_encode($iv . $encrypted);
}

function decrypt_token(string $stored): string {
    $data = base64_decode($stored);
    $iv = substr($data, 0, 16);
    $encrypted = substr($data, 16);
    return openssl_decrypt($encrypted, 'AES-256-CBC', ENCRYPT_KEY, 0, $iv);
}

function github_request(string $token, string $endpoint, string $method = 'GET', array $body = []): array {
    $ch = curl_init("https://api.github.com/$endpoint");
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_HTTPHEADER => [
            "Authorization: Bearer $token",
            "Accept: application/vnd.github+json",
            "User-Agent: TeamApp/1.0",
            "X-GitHub-Api-Version: 2022-11-28"
        ],
        CURLOPT_CUSTOMREQUEST => $method,
    ]);
    if (!empty($body)) {
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($body));
    }
    $response = curl_exec($ch);
    $status = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    return ['status' => $status, 'body' => json_decode($response, true)];
}

function connect_repo(int $project_id, string $repo_full_name, string $access_token): array {
    $pdo = get_db();
    $encrypted = encrypt_token($access_token);
    $stmt = $pdo->prepare('INSERT INTO github_repos (project_id, repo_full_name, access_token) VALUES (?,?,?) ON DUPLICATE KEY UPDATE repo_full_name=VALUES(repo_full_name), access_token=VALUES(access_token)');
    $stmt->execute([$project_id, $repo_full_name, $encrypted]);
    return ['success' => true];
}

function get_repo_for_project(int $project_id): ?array {
    $pdo = get_db();
    $stmt = $pdo->prepare('SELECT * FROM github_repos WHERE project_id = ?');
    $stmt->execute([$project_id]);
    $row = $stmt->fetch();
    if (!$row) return null;
    $row['access_token'] = decrypt_token($row['access_token']);
    return $row;
}

function create_branch_for_issue(int $issue_id, string $branch_name, int $user_id): array {
    $pdo = get_db();
    $issue = get_issue($issue_id);
    if (!$issue) return ['success' => false, 'error' => 'Issue not found'];

    $repo = get_repo_for_project($issue['project_id']);
    if (!$repo) return ['success' => false, 'error' => 'No GitHub repo connected'];

    // Get default branch SHA
    $repoData = github_request($repo['access_token'], "repos/{$repo['repo_full_name']}");
    $defaultBranch = $repoData['body']['default_branch'] ?? 'main';
    $refData = github_request($repo['access_token'], "repos/{$repo['repo_full_name']}/git/ref/heads/$defaultBranch");
    $sha = $refData['body']['object']['sha'] ?? null;
    if (!$sha) return ['success' => false, 'error' => 'Could not get branch SHA'];

    // Create branch
    $result = github_request($repo['access_token'], "repos/{$repo['repo_full_name']}/git/refs", 'POST', [
        'ref' => "refs/heads/$branch_name",
        'sha' => $sha
    ]);

    if ($result['status'] !== 201) {
        return ['success' => false, 'error' => $result['body']['message'] ?? 'GitHub error'];
    }

    // Save to DB
    $pdo->prepare('INSERT INTO branches (issue_id, branch_name, created_by) VALUES (?,?,?)')
        ->execute([$issue_id, $branch_name, $user_id]);

    return ['success' => true, 'branch' => $branch_name];
}

function get_issue_branches(int $issue_id): array {
    $pdo = get_db();
    $stmt = $pdo->prepare('SELECT b.*, u.name as creator_name FROM branches b JOIN users u ON b.created_by = u.id WHERE b.issue_id = ?');
    $stmt->execute([$issue_id]);
    return $stmt->fetchAll();
}

// HTTP routing
if (php_sapi_name() !== 'cli') {
    require_once __DIR__ . '/issues.php';
    require_auth();
    header('Content-Type: application/json');
    $method = $_SERVER['REQUEST_METHOD'];
    $action = $_GET['action'] ?? '';
    $b = $method === 'POST' ? json_decode(file_get_contents('php://input'), true) : [];

    match(true) {
        $method === 'POST' && $action === 'connect_repo'  => print json_encode(connect_repo((int)$b['project_id'], $b['repo_full_name'], $b['access_token'])),
        $method === 'POST' && $action === 'create_branch' => print json_encode(create_branch_for_issue((int)$b['issue_id'], $b['branch_name'], current_user()['id'])),
        $method === 'GET'  && $action === 'branches'      => print json_encode(['success'=>true,'data'=>get_issue_branches((int)($_GET['issue_id']??0))]),
        default => null
    };
    exit;
}
```

**Step 2: Write failing test**

```php
<?php
require_once __DIR__ . '/../config/config.php';
require_once __DIR__ . '/../app/includes/db.php';
require_once __DIR__ . '/../app/api/github.php';

// Test token encryption/decryption
$token = 'ghp_testtoken123';
$encrypted = encrypt_token($token);
assert($encrypted !== $token, 'Token should be encrypted');
$decrypted = decrypt_token($encrypted);
assert($decrypted === $token, 'Token should decrypt correctly');

echo "PASS: GitHub token encryption works\n";
```

**Step 3: Run test**

```bash
php tests/test_github.php
```

Expected: `PASS: GitHub token encryption works`

**Step 4: Commit**

```bash
git add app/api/github.php tests/test_github.php
git commit -m "feat: add GitHub integration (connect repo, create branch)"
```

---

### Task 12: Issue detail page with GitHub branch creation

**Files:**
- Create: `app/pages/issues.php`
- Create: `app/assets/js/issues.js`

**Step 1: Write `app/pages/issues.php`**

```php
<?php
$page_title = 'Issues';
require __DIR__ . '/../includes/layout_top.php';
?>
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
    <h2>Issues</h2>
    <button class="btn btn-primary" id="new-issue-btn">+ New Issue</button>
</div>

<div id="issue-list"></div>

<!-- Issue Detail Panel -->
<div id="issue-detail" class="issue-detail hidden">
    <div class="issue-detail-header">
        <button id="close-detail">âœ•</button>
        <h3 id="detail-title"></h3>
        <div id="detail-meta"></div>
    </div>
    <div id="detail-desc"></div>
    <hr>
    <div class="github-section">
        <strong>GitHub Branches</strong>
        <div id="branch-list"></div>
        <div style="margin-top:0.5rem;display:flex;gap:0.5rem;">
            <input type="text" id="branch-input" placeholder="feature/issue-42-name">
            <button class="btn btn-primary" id="create-branch-btn">Create Branch</button>
        </div>
    </div>
    <hr>
    <div class="comments-section">
        <strong>Comments</strong>
        <div id="comments-list"></div>
    </div>
</div>

<script>const APP_URL = '<?= APP_URL ?>'; const PROJECT_ID = 1;</script>
<script src="<?= APP_URL ?>/app/assets/js/issues.js"></script>
<?php require __DIR__ . '/../includes/layout_bottom.php'; ?>
```

**Step 2: Write `app/assets/js/issues.js`**

```javascript
let currentIssueId = null;

async function loadIssues() {
    const res = await fetch(`${APP_URL}/app/api/issues.php?action=list&project_id=${PROJECT_ID}`);
    const data = await res.json();
    const list = document.getElementById('issue-list');
    list.innerHTML = '';
    (data.data || []).forEach(issue => {
        const el = document.createElement('div');
        el.className = 'card issue-row';
        el.style.cssText = 'cursor:pointer;display:flex;justify-content:space-between;align-items:center;';
        el.innerHTML = `<div><strong>#${issue.id}</strong> ${issue.title}</div>
            <div style="display:flex;gap:0.5rem;font-size:0.8rem;">
                <span class="badge badge-${issue.priority}">${issue.priority}</span>
                <span class="badge" style="background:#e5e7eb">${issue.status}</span>
            </div>`;
        el.addEventListener('click', () => openIssue(issue.id, issue.title, issue.description));
        list.appendChild(el);
    });
}

async function openIssue(id, title, desc) {
    currentIssueId = id;
    document.getElementById('detail-title').textContent = `#${id} ${title}`;
    document.getElementById('detail-desc').innerHTML = desc || '<em>No description</em>';
    document.getElementById('branch-input').value = `feature/issue-${id}-`;
    document.getElementById('issue-detail').classList.remove('hidden');
    await loadBranches(id);
}

async function loadBranches(id) {
    const res = await fetch(`${APP_URL}/app/api/github.php?action=branches&issue_id=${id}`);
    const data = await res.json();
    const list = document.getElementById('branch-list');
    list.innerHTML = (data.data || []).map(b => `<div class="branch-item">ðŸŒ¿ ${b.branch_name} <span style="color:#aaa;font-size:0.8rem">by ${b.creator_name}</span></div>`).join('') || '<em style="color:#aaa">No branches yet</em>';
}

document.getElementById('create-branch-btn').addEventListener('click', async () => {
    const branch = document.getElementById('branch-input').value.trim();
    if (!branch || !currentIssueId) return;
    const res = await fetch(`${APP_URL}/app/api/github.php?action=create_branch`, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ issue_id: currentIssueId, branch_name: branch })
    });
    const data = await res.json();
    if (data.success) { await loadBranches(currentIssueId); }
    else { alert(data.error); }
});

document.getElementById('close-detail').addEventListener('click', () => {
    document.getElementById('issue-detail').classList.add('hidden');
});

loadIssues();
```

**Step 3: Add CSS to `main.css`**

```css
/* Issues */
.issue-detail { position: fixed; right: 0; top: 0; bottom: 0; width: 420px; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.1); padding: 1.5rem; overflow-y: auto; z-index: 50; }
.issue-detail-header { margin-bottom: 1rem; }
.issue-detail-header button { background: none; border: none; font-size: 1.2rem; cursor: pointer; float: right; }
.github-section, .comments-section { padding: 1rem 0; }
.branch-item { padding: 0.4rem 0; border-bottom: 1px solid #f3f4f6; font-size: 0.875rem; }
```

**Step 4: Verify in browser**

Visit `?page=issues`, click an issue, verify detail panel opens, connect a GitHub repo first via dev tools if needed.

**Step 5: Commit**

```bash
git add app/pages/issues.php app/assets/js/issues.js app/assets/css/main.css
git commit -m "feat: add issues list and detail panel with GitHub branch creation"
```

---

## Phase 7: Team Management

---

### Task 13: Team and user management

**Files:**
- Create: `app/api/team.php`
- Create: `app/pages/team.php`
- Create: `tests/test_team.php`

**Step 1: Write failing test**

```php
<?php
session_start();
require_once __DIR__ . '/../config/config.php';
require_once __DIR__ . '/../app/includes/db.php';
require_once __DIR__ . '/../app/includes/auth.php';
require_once __DIR__ . '/../app/api/team.php';

$_SESSION['user'] = ['id' => 1, 'role' => 'admin'];

$members = list_team_members(1);
assert(is_array($members), 'Should return array');
assert(count($members) >= 1, 'Should have at least one member');

echo "PASS: Team management works\n";
```

**Step 2: Write `app/api/team.php`**

```php
<?php
function list_team_members(int $team_id): array {
    $pdo = get_db();
    $stmt = $pdo->prepare('SELECT u.id, u.name, u.email, u.avatar, u.role, tm.role as team_role FROM users u JOIN team_members tm ON u.id = tm.user_id WHERE tm.team_id = ?');
    $stmt->execute([$team_id]);
    return $stmt->fetchAll();
}

function invite_user(string $name, string $email, string $role, int $team_id): array {
    $pdo = get_db();
    // Check if user already exists
    $stmt = $pdo->prepare('SELECT id FROM users WHERE email = ?');
    $stmt->execute([$email]);
    $existing = $stmt->fetchColumn();
    if ($existing) return ['success' => false, 'error' => 'User already exists'];

    $temp_password = bin2hex(random_bytes(8));
    $hash = password_hash($temp_password, PASSWORD_DEFAULT);
    $pdo->prepare('INSERT INTO users (name, email, password_hash, role) VALUES (?,?,?,?)')->execute([$name, $email, $hash, $role]);
    $user_id = (int)$pdo->lastInsertId();
    $pdo->prepare('INSERT INTO team_members (user_id, team_id, role) VALUES (?,?,?)')->execute([$user_id, $team_id, $role]);

    return ['success' => true, 'temp_password' => $temp_password, 'user_id' => $user_id];
}

function update_user_role(int $user_id, string $role): array {
    get_db()->prepare('UPDATE users SET role = ? WHERE id = ?')->execute([$role, $user_id]);
    return ['success' => true];
}

function remove_team_member(int $user_id, int $team_id): array {
    get_db()->prepare('DELETE FROM team_members WHERE user_id = ? AND team_id = ?')->execute([$user_id, $team_id]);
    return ['success' => true];
}

if (php_sapi_name() !== 'cli') {
    require_auth();
    header('Content-Type: application/json');
    $method = $_SERVER['REQUEST_METHOD'];
    $action = $_GET['action'] ?? '';
    $b = $method === 'POST' ? json_decode(file_get_contents('php://input'), true) : [];

    match(true) {
        $method === 'GET'  && $action === 'members' => print json_encode(['success'=>true,'data'=>list_team_members(1)]),
        $method === 'POST' && $action === 'invite'  => (function() use ($b) { require_role('admin'); print json_encode(invite_user($b['name'], $b['email'], $b['role']??'member', 1)); })(),
        $method === 'POST' && $action === 'remove'  => (function() use ($b) { require_role('admin'); print json_encode(remove_team_member((int)$b['user_id'], 1)); })(),
        default => null
    };
    exit;
}
```

**Step 3: Write `app/pages/team.php`**

```php
<?php
$page_title = 'Team';
require __DIR__ . '/../includes/layout_top.php';
?>
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
    <h2>Team Members</h2>
    <?php if (has_role('admin')): ?>
    <button class="btn btn-primary" id="invite-btn">+ Invite Member</button>
    <?php endif; ?>
</div>
<div id="members-list"></div>

<?php if (has_role('admin')): ?>
<div id="invite-modal" class="modal hidden">
    <div class="modal-box">
        <h3>Invite Member</h3>
        <input type="text" id="invite-name" placeholder="Name" style="width:100%;padding:0.5rem;margin-bottom:0.5rem;border:1px solid #ddd;border-radius:4px;">
        <input type="email" id="invite-email" placeholder="Email" style="width:100%;padding:0.5rem;margin-bottom:0.5rem;border:1px solid #ddd;border-radius:4px;">
        <select id="invite-role" style="width:100%;padding:0.5rem;margin-bottom:1rem;border:1px solid #ddd;border-radius:4px;">
            <option value="member">Member</option>
            <option value="admin">Admin</option>
        </select>
        <div id="invite-result" style="font-size:0.85rem;margin-bottom:0.75rem;color:#059669;"></div>
        <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
            <button class="btn btn-secondary" id="invite-cancel">Cancel</button>
            <button class="btn btn-primary" id="invite-save">Invite</button>
        </div>
    </div>
</div>
<script>
document.getElementById('invite-btn').addEventListener('click', () => document.getElementById('invite-modal').classList.remove('hidden'));
document.getElementById('invite-cancel').addEventListener('click', () => document.getElementById('invite-modal').classList.add('hidden'));
document.getElementById('invite-save').addEventListener('click', async () => {
    const res = await fetch(`<?= APP_URL ?>/app/api/team.php?action=invite`, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name: document.getElementById('invite-name').value, email: document.getElementById('invite-email').value, role: document.getElementById('invite-role').value })
    });
    const data = await res.json();
    if (data.success) {
        document.getElementById('invite-result').textContent = `User created. Temp password: ${data.temp_password}`;
        loadMembers();
    } else {
        document.getElementById('invite-result').style.color = '#dc2626';
        document.getElementById('invite-result').textContent = data.error;
    }
});
</script>
<?php endif; ?>

<script>
const APP_URL = '<?= APP_URL ?>';
async function loadMembers() {
    const res = await fetch(`${APP_URL}/app/api/team.php?action=members`);
    const data = await res.json();
    const list = document.getElementById('members-list');
    list.innerHTML = (data.data || []).map(m => `
        <div class="card" style="display:flex;justify-content:space-between;align-items:center;">
            <div><strong>${m.name}</strong> <span style="color:#888;font-size:0.85rem">${m.email}</span></div>
            <span class="badge" style="background:#e5e7eb">${m.team_role}</span>
        </div>`).join('');
}
loadMembers();
</script>
<?php require __DIR__ . '/../includes/layout_bottom.php'; ?>
```

**Step 4: Run test**

```bash
php tests/test_team.php
```

Expected: `PASS: Team management works`

**Step 5: Commit**

```bash
git add app/api/team.php app/pages/team.php tests/test_team.php
git commit -m "feat: add team management with invite and role system"
```

---

## Phase 8: Final Polish

---

### Task 14: Projects management page

**Files:**
- Create: `app/api/projects.php`
- Create: `app/pages/projects.php`

**Step 1: Write `app/api/projects.php`**

```php
<?php
function list_projects(): array {
    $stmt = get_db()->query('SELECT * FROM projects ORDER BY created_at DESC');
    return $stmt->fetchAll();
}

function create_project(string $name, ?string $description, int $user_id): array {
    $pdo = get_db();
    $pdo->prepare('INSERT INTO projects (name, description, created_by) VALUES (?,?,?)')->execute([$name, $description, $user_id]);
    return ['success' => true, 'id' => (int)$pdo->lastInsertId()];
}

if (php_sapi_name() !== 'cli') {
    require_auth();
    header('Content-Type: application/json');
    $method = $_SERVER['REQUEST_METHOD'];
    $action = $_GET['action'] ?? '';
    $b = $method === 'POST' ? json_decode(file_get_contents('php://input'), true) : [];

    match(true) {
        $method === 'GET'  && $action === 'list'   => print json_encode(['success'=>true,'data'=>list_projects()]),
        $method === 'POST' && $action === 'create' => print json_encode(create_project($b['name'], $b['description']??null, current_user()['id'])),
        default => null
    };
    exit;
}
```

**Step 2: Commit**

```bash
git add app/api/projects.php
git commit -m "feat: add projects API"
```

---

### Task 15: Run full manual test checklist

**Test each flow end-to-end in the browser:**

1. Login with `admin@example.com` / `password`
2. Navigate to Wiki â€” create a page, edit it, verify auto-save
3. Navigate to Kanban â€” create an issue, drag it between columns
4. Navigate to Issues â€” click an issue, open detail panel
5. Navigate to Team â€” invite a new member, verify temp password shown
6. Logout â€” verify session is cleared and redirected to login

**Fix any issues found, commit fixes with `fix:` prefix.**

---

### Task 16: Final commit

```bash
git add .
git commit -m "$(cat <<'EOF'
feat: complete WINOJI initial implementation

- Auth with PHP sessions and role-based access
- Wiki with nested pages, rich-text editor, auto-save, version history
- Kanban board with drag-and-drop
- Issues with filters and detail panel
- GitHub integration: connect repo, create branches from issues
- Team management with invite and roles

Co-Authored-By: Claude Sonnet 4.6 <noreply@anthropic.com>
EOF
)"
```

---

*End of plan.*
